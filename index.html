<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="description" content="êµ­ë‚´ì£¼ì‹, í•´ì™¸ì£¼ì‹, ì½”ì¸, í˜„ê¸ˆ, ì˜ˆì ê¸ˆì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë¬´ë£Œ ìì‚° ê´€ë¦¬ ë„êµ¬. ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸, ì†ìµ ë¶„ì„, ìì‚° êµ¬ì„± ì°¨íŠ¸ ì œê³µ.">
<meta property="og:title" content="My Portfolio - ìì‚° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ">
<meta property="og:description" content="ì£¼ì‹Â·ì½”ì¸Â·í˜„ê¸ˆÂ·ì˜ˆì ê¸ˆì„ í•œëˆˆì—. ì‹¤ì‹œê°„ ê°€ê²© ìµœì‹ í™”, ì†ìµ ë¶„ì„, ìì‚° êµ¬ì„± ì°¨íŠ¸ê¹Œì§€.">
<meta property="og:type" content="website">
<meta name="theme-color" content="#0B0D11">
<title>My Portfolio - ìì‚° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0B0D11;--bg2:#111318;--card:#1A1D23;--card2:#0F1117;--bd:rgba(255,255,255,0.05);--t1:#F1F5F9;--t2:#CBD5E1;--t3:#94A3B8;--t4:#64748B;--t5:#475569;--blue:#3B82F6;--purple:#8B5CF6;--amber:#F59E0B;--green:#10B981;--red:#EF4444;--pink:#EC4899;--cyan:#06B6D4}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{background:var(--bg)}body{font-family:'Pretendard Variable',-apple-system,BlinkMacSystemFont,sans-serif;color:var(--t2);background:linear-gradient(180deg,var(--bg),var(--bg2));min-height:100vh;-webkit-font-smoothing:antialiased}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}input[type=number]{-moz-appearance:textfield}select{-webkit-appearance:none}button{font-family:inherit}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}@keyframes spin{to{transform:rotate(360deg)}}@keyframes modalIn{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}@keyframes flash{0%{box-shadow:0 0 0 0 rgba(16,185,129,.4)}100%{box-shadow:0 0 0 14px rgba(16,185,129,0)}}
.wrap{max-width:820px;margin:0 auto;padding:0 20px}.card{background:var(--card);border-radius:18px;padding:22px;border:1px solid var(--bd);margin-bottom:14px}.hidden{display:none!important}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 20px;border-radius:12px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit}.btn:disabled{opacity:.4;cursor:not-allowed}.btn-p{background:linear-gradient(135deg,var(--blue),#2563EB);color:#fff}.btn-d{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.15)}.btn-g{background:rgba(255,255,255,.05);color:var(--t2);border:1px solid rgba(255,255,255,.08)}.btn-w{width:100%}
.btn-buy{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.1);font-size:12px;padding:6px 12px;border-radius:8px;cursor:pointer;font-family:inherit}.btn-sell{background:rgba(59,130,246,.08);color:var(--blue);border:1px solid rgba(59,130,246,.1);font-size:12px;padding:6px 12px;border-radius:8px;cursor:pointer;font-family:inherit}
.ibtn{width:34px;height:34px;border-radius:9px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;border:none;transition:all .12s}.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(245,158,11,.25);border-top-color:var(--amber);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}.spinner.sm{width:13px;height:13px;border-width:1.5px}
.hdr{padding:18px 0 12px;border-bottom:1px solid rgba(255,255,255,.03)}.hdr-bg{background:linear-gradient(180deg,rgba(59,130,246,.06),transparent);padding-bottom:8px}.hdr-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}.logo-s{font-size:10px;color:var(--t4);letter-spacing:.1em;font-weight:600;text-transform:uppercase}.logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,#60A5FA,#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:1px}
.tabs{display:flex;gap:3px;background:rgba(255,255,255,.025);border-radius:13px;padding:3px;margin:14px 0 18px}.tab{flex:1;padding:9px 0;border-radius:10px;border:none;background:transparent;color:var(--t4);font-size:12.5px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .15s;font-family:inherit}.tab.on{background:rgba(59,130,246,.14);color:#60A5FA}
.tot{background:linear-gradient(135deg,#14213D,var(--card));border-radius:20px;padding:24px;border:1px solid rgba(59,130,246,.1);position:relative;overflow:hidden;margin-bottom:14px}.tot .glow{position:absolute;top:-50px;right:-50px;width:160px;height:160px;background:radial-gradient(circle,rgba(59,130,246,.1),transparent 70%);pointer-events:none}.tot-n{font-size:30px;font-weight:800;color:var(--t1);letter-spacing:-.02em}
.chg{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:7px;font-size:12px;font-weight:600}.chg-u{background:rgba(239,68,68,.08);color:var(--red)}.chg-d{background:rgba(59,130,246,.08);color:#60A5FA}
.ai{background:linear-gradient(135deg,rgba(16,185,129,.04),rgba(59,130,246,.04));border-radius:15px;padding:15px 16px;border:1px solid rgba(16,185,129,.08);margin-bottom:14px}.ai-btn{background:linear-gradient(135deg,var(--green),#059669);border:none;color:#fff;padding:9px 16px;border-radius:11px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:7px;white-space:nowrap;font-family:inherit}.ai-btn:disabled{background:rgba(16,185,129,.08);color:var(--green);cursor:not-allowed}
.cg{background:var(--card);border-radius:15px;margin-bottom:10px;border:1px solid var(--bd);overflow:hidden}.cg-h{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.03)}.ar{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.02);transition:background .1s}.ar:last-child{border-bottom:none}.tag{font-size:8.5px;padding:1px 5px;border-radius:4px;font-weight:600;margin-left:5px;vertical-align:middle}
.mbg{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(5px)}.mdl{background:var(--card);border-radius:20px;padding:26px;width:min(480px,94vw);max-height:88vh;overflow-y:auto;border:1px solid rgba(255,255,255,.08);box-shadow:0 25px 70px rgba(0,0,0,.6);animation:modalIn .2s ease}.mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.mt{font-size:18px;font-weight:700;color:var(--t1)}.mc{background:rgba(255,255,255,.05);border:none;color:var(--t3);width:32px;height:32px;border-radius:9px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.fld{margin-bottom:15px}.fld label{display:block;font-size:12.5px;color:var(--t3);margin-bottom:5px;font-weight:500}.fld input,.fld select{width:100%;padding:11px 13px;border-radius:11px;border:1px solid rgba(255,255,255,.08);background:var(--card2);color:var(--t1);font-size:14px;outline:none;font-family:inherit;transition:border-color .2s}.fld input:focus,.fld select:focus{border-color:rgba(59,130,246,.4)}.fld .ht{font-size:10.5px;color:var(--amber);margin-top:3px}.wl-chain{display:flex;align-items:center;gap:10px;padding:11px 13px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:11px;margin-bottom:8px;transition:all .15s}.wl-chain.found{border-color:rgba(16,185,129,.15);background:rgba(16,185,129,.03)}.wl-chain .wl-ic{font-size:20px;flex-shrink:0}.wl-chain .wl-info{flex:1;min-width:0}.wl-chain .wl-nm{font-size:12.5px;color:var(--t2);font-weight:600}.wl-chain .wl-bal{font-size:11px;color:var(--t4);margin-top:2px}.wl-chain .wl-val{font-size:12.5px;font-weight:700;color:var(--t1);white-space:nowrap}.wl-chain .wl-st{font-size:10px;color:var(--t5)}.wl-cb{width:18px;height:18px;accent-color:var(--green);cursor:pointer;flex-shrink:0}.wl-prog{height:3px;background:rgba(255,255,255,.06);border-radius:2px;margin:12px 0;overflow:hidden}.wl-prog-bar{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:2px;transition:width .3s}.sel-wrap{position:relative}.sel-wrap select{padding-right:36px;cursor:pointer}.sel-wrap::after{content:"â–¼";position:absolute;right:13px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--t4);pointer-events:none}.mbtn{display:flex;gap:8px;margin-top:10px}.mbtn .btn{flex:1}
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:5px;margin-top:6px;max-height:145px;overflow-y:auto}.cchip{padding:5px 7px;border-radius:7px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);color:var(--t3);font-size:11px;cursor:pointer;text-align:center;transition:all .12s;font-family:inherit}.cchip:hover,.cchip.sel{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.2);color:var(--amber)}
.lgbox{margin-top:8px;border-top:1px solid rgba(255,255,255,.04);padding-top:7px;max-height:120px;overflow-y:auto}.lgi{font-size:11px;padding:2px 0;display:flex;gap:5px;align-items:center;color:var(--t3)}.lgi.bad{color:var(--red)}.hrow{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03)}.hrow:last-child{border-bottom:none}
.mkt-sel{display:flex;gap:4px;margin-top:4px}.mkt-opt{padding:5px 10px;border-radius:7px;font-size:11px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:var(--t3);cursor:pointer;font-family:inherit;transition:all .12s}.mkt-opt:hover,.mkt-opt.sel{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.2);color:#60A5FA}
.dtgl{display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:4px 10px;border-radius:7px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04);color:var(--t4);font-size:11px;cursor:pointer;font-family:inherit;transition:all .12s}.dtgl:hover{background:rgba(255,255,255,.06);color:var(--t2)}
.dsec{background:rgba(255,255,255,.02);border-radius:12px;padding:14px;margin-top:8px;border:1px solid rgba(255,255,255,.03)}.dgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}.ditem{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,.02)}.ditem .dl{font-size:10.5px;color:var(--t4)}.ditem .dv{font-size:14px;font-weight:700;color:var(--t1);margin-top:2px}
.txr{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.02);font-size:11.5px}.txr:last-child{border-bottom:none}.txt{padding:2px 7px;border-radius:5px;font-size:10px;font-weight:700}.txb{background:rgba(239,68,68,.08);color:var(--red)}.txs{background:rgba(59,130,246,.08);color:var(--blue)}.txa{padding:1px 6px;border-radius:4px;background:rgba(255,255,255,.04);color:var(--t4);font-size:10px}
.acr{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.02);margin-bottom:4px;font-size:12px}.noth{margin-top:4px;padding:6px 10px;background:rgba(255,255,255,.02);border-radius:7px;font-size:11px;color:var(--t4)}
@media(max-width:480px){.tot-n{font-size:24px}.wrap{padding:0 14px}.card{padding:18px 16px}.dgrid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="hdr-bg"><div class="hdr"><div class="wrap"><div class="hdr-row"><div><div class="logo-s">My Portfolio</div><div class="logo">ìì‚° ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</div></div><div style="display:flex;gap:7px"><button id="btnSnap" onclick="doSnap()" title="ì˜¤ëŠ˜ ê¸°ë¡ ì €ì¥" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.15);color:var(--green);width:38px;height:38px;border-radius:11px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">ğŸ“¸</button><button onclick="openWallet()" title="ì§€ê°‘ ì—°ë™" style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.15);color:var(--amber);height:38px;border-radius:11px;cursor:pointer;padding:0 12px;font-size:13px;font-weight:700;display:flex;align-items:center;gap:4px;font-family:inherit">ğŸ”— ì§€ê°‘</button><button onclick="openAdd()" style="background:linear-gradient(135deg,var(--blue),#2563EB);border:none;color:#fff;height:38px;border-radius:11px;cursor:pointer;padding:0 14px;font-size:13px;font-weight:700;display:flex;align-items:center;gap:4px;font-family:inherit"><span style="font-size:17px">+</span> ìì‚° ì¶”ê°€</button></div></div><div style="font-size:10px;color:var(--t5);margin-top:5px" id="elSaved"></div></div></div></div>
<div class="wrap"><div class="tabs"><button class="tab on" data-t="dash" onclick="goTab('dash')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button><button class="tab" data-t="list" onclick="goTab('list')">ğŸ’¼ ìì‚° ëª©ë¡</button><button class="tab" data-t="hist" onclick="goTab('hist')">ğŸ“ˆ ë³€ë™ ì¶”ì´</button><button class="tab" data-t="ai" onclick="goTab('ai')">ğŸ¤– AI ì»¨ì„¤í„´íŠ¸</button></div></div>
<div class="wrap" style="padding-bottom:80px"><div id="pgDash"></div><div id="pgList" class="hidden"></div><div id="pgHist" class="hidden"></div><div id="pgAi" class="hidden"></div></div>
<div class="mbg hidden" id="mBg" onclick="closeM()"><div class="mdl" onclick="event.stopPropagation()"><div class="mh"><div class="mt" id="mTi"></div><button class="mc" onclick="closeM()">âœ•</button></div><div id="mBd"></div></div></div>
<script>
var CAT={"êµ­ë‚´ì£¼ì‹":{c:"#3B82F6",ic:"ğŸ“ˆ"},"í•´ì™¸ì£¼ì‹":{c:"#8B5CF6",ic:"ğŸŒ"},"ì½”ì¸":{c:"#F59E0B",ic:"â‚¿"},"í˜„ê¸ˆ":{c:"#10B981",ic:"ğŸ’µ"},"ì˜ˆì ê¸ˆ":{c:"#06B6D4",ic:"ğŸ¦"},"ë¶€ë™ì‚°":{c:"#EC4899",ic:"ğŸ "},"ê¸°íƒ€":{c:"#A78BFA",ic:"ğŸ“¦"}};
var CATS=Object.keys(CAT),SK="myportfolio_v9";
var COIN_MAP={"ë¹„íŠ¸ì½”ì¸":"bitcoin","ì´ë”ë¦¬ì›€":"ethereum","ë¦¬í”Œ":"ripple","ì†”ë¼ë‚˜":"solana","íŠ¸ë¡ ":"tron","ìˆ˜ì´":"sui","í•˜ì´í¼ë¦¬í€´ë“œ":"hyperliquid","ë°”ì´ë‚¸ìŠ¤ì½”ì¸":"binancecoin","í…Œë”":"tether","ìœ ì—ìŠ¤ë””ì”¨":"usd-coin","ìœ ì—ìŠ¤ë””ì›":"usd1-wlfi","btc":"bitcoin","eth":"ethereum","xrp":"ripple","sol":"solana","trx":"tron","sui":"sui","hype":"hyperliquid","bnb":"binancecoin","usdt":"tether","usdc":"usd-coin","usd1":"usd1-wlfi"};
var COIN_KR={"bitcoin":"ë¹„íŠ¸ì½”ì¸","ethereum":"ì´ë”ë¦¬ì›€","ripple":"ë¦¬í”Œ","solana":"ì†”ë¼ë‚˜","tron":"íŠ¸ë¡ ","sui":"ìˆ˜ì´","hyperliquid":"í•˜ì´í¼ë¦¬í€´ë“œ","binancecoin":"ë°”ì´ë‚¸ìŠ¤ì½”ì¸(BNB)","tether":"USDT","usd-coin":"USDC","usd1-wlfi":"USD1"};
var TOP_COINS=["bitcoin","ethereum","ripple","tron","solana","sui","hyperliquid","binancecoin","usd-coin","usd1-wlfi"];
var KR_STOCKS=[{n:"ì‚¼ì„±ì „ì",c:"005930"},{n:"SKí•˜ì´ë‹‰ìŠ¤",c:"000660"},{n:"LGì—ë„ˆì§€ì†”ë£¨ì…˜",c:"373220"},{n:"í˜„ëŒ€ì°¨",c:"005380"},{n:"ê¸°ì•„",c:"000270"},{n:"ì…€íŠ¸ë¦¬ì˜¨",c:"068270"},{n:"KBê¸ˆìœµ",c:"105560"},{n:"NAVER",c:"035420"},{n:"ì¹´ì¹´ì˜¤",c:"035720"},{n:"ì‚¼ì„±SDI",c:"006400"},{n:"POSCOí™€ë”©ìŠ¤",c:"005490"},{n:"í˜„ëŒ€ëª¨ë¹„ìŠ¤",c:"012330"},{n:"KODEX 200",c:"069500"},{n:"KODEX ë°˜ë„ì²´",c:"091160"},{n:"KODEX 2ì°¨ì „ì§€",c:"305720"},{n:"TIGER ë°˜ë„ì²´",c:"091230"},{n:"SOL ì¡°ì„ TOP3í”ŒëŸ¬ìŠ¤",c:"466920"},{n:"KODEX ìë™ì°¨",c:"091170"}];
var KR_FOREIGN_ETF=[{n:"TIGER ë¯¸êµ­S&P500",c:"360750"},{n:"KODEX ë¯¸êµ­S&P500",c:"379800"},{n:"ACE ë¯¸êµ­S&P500",c:"360200"},{n:"RISE ë¯¸êµ­S&P500",c:"379780"},{n:"SOL ë¯¸êµ­S&P500",c:"433330"},{n:"KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100",c:"379810"},{n:"TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100",c:"133690"},{n:"ACE ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100",c:"368590"},{n:"TIGER ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤",c:"458730"},{n:"KODEX ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤",c:"489250"},{n:"ACE ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤",c:"402970"},{n:"SOL ë¯¸êµ­ë°°ë‹¹ë‹¤ìš°ì¡´ìŠ¤",c:"446720"},{n:"KODEX ë¯¸êµ­ë°˜ë„ì²´MV",c:"390390"},{n:"ACE ë¯¸êµ­ë¹…í…Œí¬TOP7 Plus",c:"465580"},{n:"TIGER ë¯¸êµ­í•„ë¼ë¸í”¼ì•„AIë°˜ë„ì²´ë‚˜ìŠ¤ë‹¥",c:"381180"},{n:"KODEX ë¯¸êµ­AIì „ë ¥í•µì‹¬ì¸í”„ë¼",c:"495090"},{n:"ACE ê¸€ë¡œë²Œë°˜ë„ì²´TOP4 Plus SOLACTIVE",c:"448540"},{n:"TIGER ì°¨ì´ë‚˜í•­ì…í…Œí¬",c:"371460"},{n:"TIGER ì¸ë„ë‹ˆí”„í‹°50",c:"236350"},{n:"KODEX ì¸ë„Nifty50",c:"453810"},{n:"TIGER ì¼ë³¸ë‹ˆì¼€ì´225",c:"241180"},{n:"KODEX ë¯¸êµ­ì„œí•™ê°œë¯¸",c:"473460"},{n:"TIGER ê¸€ë¡œë²Œí˜ì‹ ë¸”ë£¨ì¹©TOP10",c:"469150"},{n:"ACE í…ŒìŠ¬ë¼ë°¸ë¥˜ì²´ì¸ì•¡í‹°ë¸Œ",c:"456250"}];
var fS=function(n){if(!n)return"0ì›";var a=Math.abs(n),s=n<0?"-":"";if(a>=1e8){var uk=Math.floor(a/1e8),rem=a-uk*1e8;var man=Math.floor(rem/1e4),won=Math.round(rem%1e4);if(man>0&&won>0)return s+uk+"ì–µ "+man+"ë§Œ "+won+"ì›";if(man>0)return s+uk+"ì–µ "+man+"ë§Œì›";if(won>0)return s+uk+"ì–µ "+won+"ì›";return s+uk+"ì–µì›"}if(a>=1e4){var man2=Math.floor(a/1e4),won2=Math.round(a%1e4);if(won2>0)return s+man2+"ë§Œ "+won2+"ì›";return s+man2+"ë§Œì›"}return s+a+"ì›"};
var fSM=function(n){if(!n)return"0ì›";var a=Math.abs(n),s=n<0?"-":"";if(a>=1e8){var uk=Math.floor(a/1e8),rem=a-uk*1e8;var man=Math.floor(rem/1e4);if(man>0)return s+uk+"ì–µ "+man+"ë§Œì›";return s+uk+"ì–µì›"}if(a>=1e4)return s+Math.floor(a/1e4)+"ë§Œì›";return s+a+"ì›"};
var fF=function(n){return Math.round(n).toLocaleString()+"ì›"};
var toDay=function(){var d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")};
var toNow=function(){return new Date().toLocaleString("ko-KR")};
var esc=function(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML};
var catOpts=function(sel){return CATS.map(function(c){return"<option value=\""+c+"\""+(c===sel?" selected":"")+">"+CAT[c].ic+" "+c+"</option>"}).join("")};
function calcAsset(a){var txns=(a.txns||[]).slice().sort(function(x,y){return(x.date||"").localeCompare(y.date||"")});if(isCashLike(a.category)){var bal=0,inCnt=0,outCnt=0;txns.forEach(function(t){if(t.type==="buy"){bal+=t.price*t.qty;inCnt+=1}else{bal-=t.price*t.qty;outCnt+=1}});return{qty:inCnt+outCnt,avgPrice:0,totalCost:0,evalAmt:Math.round(bal),profit:0,profitPct:0,accounts:[],inCnt:inCnt,outCnt:outCnt}}var tq=0,tc=0;txns.forEach(function(t){if(t.type==="buy"){tq+=t.qty;tc+=t.price*t.qty}else if(t.type==="sell"&&tq>0){var r=Math.min(t.qty,tq)/tq;tc-=tc*r;tq-=Math.min(t.qty,tq)}});var avg=tq>0?Math.round(tc/tq):0,cp=a.amount||0,ev=cp*tq,pf=ev-tc,pp=tc>0?((pf/tc)*100).toFixed(2):0;var accts={};txns.forEach(function(t){var ac=t.account||"ê¸°ë³¸";if(!accts[ac])accts[ac]={qty:0,cost:0};if(t.type==="buy"){accts[ac].qty+=t.qty;accts[ac].cost+=t.price*t.qty}else{var mq=Math.min(t.qty,accts[ac].qty);if(accts[ac].qty>0)accts[ac].cost-=accts[ac].cost*(mq/accts[ac].qty);accts[ac].qty-=mq}});var al=[];for(var k in accts){if(accts[k].qty>0){var ap=Math.round(accts[k].cost/accts[k].qty);al.push({name:k,qty:accts[k].qty,avgP:ap,eval:cp*accts[k].qty,profit:cp*accts[k].qty-accts[k].cost})}}return{qty:tq,avgPrice:avg,totalCost:Math.round(tc),evalAmt:Math.round(ev),profit:Math.round(pf),profitPct:pp,accounts:al}}
function ht(a){return a.txns&&a.txns.length>0}
function gV(a){if(!ht(a))return 0;return calcAsset(a).evalAmt}
function canAuto(a){return(a.category==="ì½”ì¸"&&a.coinId)||((a.category==="êµ­ë‚´ì£¼ì‹"||a.category==="í•´ì™¸ì£¼ì‹")&&a.stockCode)}
var Q="'";var S={assets:[],history:[],saved:null,catOrder:null,coinShowPL:true,goal:null},logs=[],loading={},allLoading=false,curTab="dash",charts={pie:null,l1:null,l2:null,catPies:{}},cachedRate=null,cachedUsdt=null,selMarket="KOSPI",expanded={},editMode=false,dashCatOpen={},catOpen={},gemResult=null,gemLoading=false;
function load(){try{var d=JSON.parse(localStorage.getItem(SK));if(d){S.assets=d.a||[];S.history=d.h||[];S.saved=d.s||null;S.catOrder=d.co||null;if(d.cpl!==undefined)S.coinShowPL=d.cpl;if(d.goal)S.goal=d.goal;S.assets.forEach(function(a){if(!a.txns)a.txns=[];if(a.krxEtf===undefined)a.krxEtf=false;if(a.isUsdt===undefined)a.isUsdt=false})}}catch(e){}}
function save(){S.saved=toNow();try{localStorage.setItem(SK,JSON.stringify({a:S.assets,h:S.history,s:S.saved,co:S.catOrder,cpl:S.coinShowPL,goal:S.goal||null}))}catch(e){}}
function txL(cat,type){if(cat==="í˜„ê¸ˆ")return type==="buy"?"ì…ê¸ˆ":"ì¶œê¸ˆ";if(cat==="ì˜ˆì ê¸ˆ")return type==="buy"?"ë‚©ì…":"ì¸ì¶œ";return type==="buy"?"ë§¤ìˆ˜":"ë§¤ë„"}
function txUnit(cat){if(cat==="í˜„ê¸ˆ"||cat==="ì˜ˆì ê¸ˆ")return"ê±´";if(cat==="ì½”ì¸")return"ê°œ";return"ì£¼"}
function isCashLike(cat){return cat==="í˜„ê¸ˆ"||cat==="ì˜ˆì ê¸ˆ"}
function mkSnap(as,hi){var t=toDay(),tot=0,byC={};CATS.forEach(function(c){byC[c]=0});as.forEach(function(a){var v=gV(a);tot+=v;byC[a.category]+=v});var nh=hi.filter(function(h){return h.date!==t});nh.push({date:t,total:tot,byCategory:byC});nh.sort(function(a,b){return a.date.localeCompare(b.date)});return nh}
function resolveCoinId(n){var l=n.toLowerCase().trim();if(COIN_MAP[l])return COIN_MAP[l];for(var k in COIN_MAP){if(k.indexOf(l)>=0||l.indexOf(k)>=0)return COIN_MAP[k]}return null}
function fetchCoinPrices(ids){if(!ids.length)return Promise.resolve({});var u=ids.filter(function(v,i,a){return a.indexOf(v)===i});return fetch("https://api.coingecko.com/api/v3/simple/price?ids="+u.join(",")+"&vs_currencies=krw").then(function(r){if(!r.ok)throw new Error(r.status);return r.json()}).catch(function(){return{}})}
var PX=[
function(u){return"https://corsproxy.io/?url="+encodeURIComponent(u)},
function(u){return"https://api.allorigins.win/raw?url="+encodeURIComponent(u)},
function(u){return"https://api.codetabs.com/v1/proxy?quest="+encodeURIComponent(u)},
function(u){return"https://corsproxy.org/?url="+encodeURIComponent(u)}
];
function tryFetch(url,ms){var i=0;function nx(){if(i>=PX.length)return Promise.resolve(null);var p=PX[i++];var tm=ms||8000;return Promise.race([fetch(p(url)).then(function(r){if(!r.ok)throw new Error(r.status);return r.text()}).then(function(t){try{return JSON.parse(t)}catch(e){return null}}),new Promise(function(r){setTimeout(function(){r(null)},tm)})]).catch(function(e){console.warn("Proxy "+i+" fail:",e.message);return nx()})}return nx()}
function yf(sym){var url="https://query1.finance.yahoo.com/v8/finance/chart/"+encodeURIComponent(sym)+"?range=1d&interval=1d";return tryFetch(url,10000).then(function(d){if(!d)return null;var pr=d&&d.chart&&d.chart.result&&d.chart.result[0]&&d.chart.result[0].meta&&d.chart.result[0].meta.regularMarketPrice;var cu=(d&&d.chart&&d.chart.result&&d.chart.result[0]&&d.chart.result[0].meta&&d.chart.result[0].meta.currency)||"USD";if(pr&&pr>0)return{price:pr,currency:cu};return null})}
function fetchNaver(code){var url="https://m.stock.naver.com/api/stock/"+code+"/basic";return tryFetch(url,8000).then(function(d){if(!d)return null;var cp=d.closePrice||d.currentPrice;if(cp)return Number(String(cp).replace(/,/g,""));if(d.stockEndPrice)return Number(String(d.stockEndPrice).replace(/,/g,""));return null}).catch(function(){return null})}
function getRate(){if(cachedRate&&Date.now()-cachedRate.t<600000)return Promise.resolve(cachedRate.r);return fetchRate()}
function fetchRate(){
  return yf("KRW=X").then(function(r){if(r&&r.price>1000){cachedRate={r:r.price,t:Date.now()};return r.price}return null})
  .then(function(v){if(v)return v;return fetch("https://open.er-api.com/v6/latest/USD").then(function(r){return r.json()}).then(function(d){if(d&&d.rates&&d.rates.KRW){cachedRate={r:d.rates.KRW,t:Date.now()};return d.rates.KRW}return null}).catch(function(){return null})})
  .then(function(v){if(v)return v;return tryFetch("https://www.floatrates.com/daily/usd.json",8000).then(function(d){if(d&&d.krw&&d.krw.rate){cachedRate={r:Math.round(d.krw.rate),t:Date.now()};return d.krw.rate}return null}).catch(function(){return null})})
  .then(function(v){return v||1350})
}
function fetchSP(a){var c=a.stockCode;if(!c)return Promise.resolve(null);if(a.category==="êµ­ë‚´ì£¼ì‹"||a.krxEtf){var sym=c+(a.market==="KOSDAQ"?".KQ":".KS");return yf(sym).then(function(r){if(r&&r.price>0)return r.price;return fetchNaver(c)})}if(a.category==="í•´ì™¸ì£¼ì‹"){return yf(c).then(function(r){if(!r)return null;if(r.currency!=="KRW")return getRate().then(function(rt){return Math.round(r.price*rt)});return r.price})}return Promise.resolve(null)}
function toggleD(id){expanded[id]=!expanded[id];render()}
function toggleDashCat(cat){dashCatOpen[cat]=!dashCatOpen[cat];rDash()}
function toggleCatOpen(cat){catOpen[cat]=catOpen[cat]===false?true:catOpen[cat]===true?false:false;render()}
function goTab(t){curTab=t;document.querySelectorAll(".tab").forEach(function(el){el.classList.toggle("on",el.dataset.t===t)});document.getElementById("pgDash").classList.toggle("hidden",t!=="dash");document.getElementById("pgList").classList.toggle("hidden",t!=="list");document.getElementById("pgHist").classList.toggle("hidden",t!=="hist");document.getElementById("pgAi").classList.toggle("hidden",t!=="ai");render()}
function render(){document.getElementById("elSaved").textContent=S.saved?"ë§ˆì§€ë§‰ ì €ì¥: "+S.saved:"";if(curTab==="dash")rDash();else if(curTab==="list")rList();else if(curTab==="hist")rHist();else if(curTab==="ai")rAi()}

function rDash(){
  var el=document.getElementById("pgDash"),total=0,inv=0,pf=0;
  for(var ck in charts.catPies){if(charts.catPies[ck])charts.catPies[ck].destroy()}charts.catPies={};
  S.assets.forEach(function(a){if(!ht(a))return;var c=calcAsset(a);total+=c.evalAmt;inv+=c.totalCost;pf+=c.profit});
  var cd=CATS.map(function(c){var v=0;S.assets.filter(function(a){return a.category===c}).forEach(function(a){v+=gV(a)});return{n:c,v:v,c:CAT[c].c,ic:CAT[c].ic}}).filter(function(d){return d.v>0}).sort(function(a,b){return b.v-a.v});
  var prev=S.history.length>=2?S.history[S.history.length-2].total:null;
  var chg=prev!==null?total-prev:null,chgP=prev?((chg/prev)*100).toFixed(2):null;
  var cht=S.history.slice(-30).map(function(h){return{d:h.date.slice(5),v:h.total}});
  var ac=S.assets.filter(canAuto).length;
  var h="<div style=\"animation:fadeUp .4s ease\">";
  if(isSandbox&&ac>0){h+="<div style=\"background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(239,68,68,.08));border:1px solid rgba(245,158,11,.2);border-radius:14px;padding:16px;margin-bottom:14px\"><div style=\"font-size:13px;font-weight:700;color:var(--amber)\">âš ï¸ ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ</div><div style=\"font-size:12px;color:var(--t3);margin-top:4px;line-height:1.6\">Claude ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” ì™¸ë¶€ APIê°€ ì°¨ë‹¨ë˜ì–´ ê°€ê²© ìµœì‹ í™”ê°€ ë¶ˆê°€í•©ë‹ˆë‹¤.<br><strong style=\"color:var(--t1)\">íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ</strong>í•œ í›„ <strong style=\"color:var(--t1)\">Chrome/Safariì—ì„œ ì§ì ‘ ì—´ì–´ì£¼ì„¸ìš”.</strong></div><div style=\"font-size:11px;color:var(--t4);margin-top:6px\">ğŸ’¡ ë‹¤ìš´ë¡œë“œ â†’ íŒŒì¼ ë”ë¸”í´ë¦­ â†’ ìë™ ìµœì‹ í™” ì •ìƒ ì‘ë™</div></div>"}
  var hasF=S.assets.some(function(a){return a.category==="í•´ì™¸ì£¼ì‹"||a.category==="ì½”ì¸"});
  if(hasF){var rr=getCurRate(),rOk=cachedRate&&cachedRate.r;var rTime=cachedRate&&cachedRate.t?new Date(cachedRate.t).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"}):"";h+="<div style=\"display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:12px;margin-bottom:14px\"><span style=\"font-size:14px\">ğŸ’±</span><div style=\"flex:1\"><span style=\"font-size:12.5px;color:var(--t3)\">USD/KRW</span> <span style=\"font-size:14px;font-weight:700;color:var(--t1)\">"+Math.round(rr).toLocaleString()+"ì›</span> "+(rOk?"<span style=\"font-size:10px;color:var(--green)\">âœ“ ì‹¤ì‹œê°„</span>":"<span style=\"font-size:10px;color:var(--amber)\">âš  ê¸°ë³¸ê°’</span>")+(rTime?" <span style=\"font-size:10px;color:var(--t5)\">"+rTime+"</span>":"")+"</div><button style=\"border:none;background:rgba(59,130,246,.08);color:#60A5FA;padding:5px 10px;border-radius:7px;font-size:11px;cursor:pointer;font-family:inherit;font-weight:600\" onclick=\"refreshRate()\">ğŸ”„ ìµœì‹ í™”</button></div>"}
  h+="<div class=\"tot\"><div class=\"glow\"></div><div style=\"font-size:12px;color:var(--t3);margin-bottom:5px;font-weight:500\">ì´ ìì‚°</div><div class=\"tot-n\">"+fF(total)+"</div>";
  if(chg!==null)h+="<div style=\"display:flex;align-items:center;gap:7px;margin-top:7px;flex-wrap:wrap\"><span class=\"chg "+(chg>=0?"chg-u":"chg-d")+"\">"+(chg>=0?"â–²":"â–¼")+" "+fSM(Math.abs(chg))+"</span><span style=\"font-size:12px;color:"+(chg>=0?"var(--red)":"#60A5FA")+"\">("+(chg>=0?"+":"")+chgP+"%)</span><span style=\"font-size:10px;color:var(--t5)\">ì „ì¼ ëŒ€ë¹„</span></div>";
  if(inv>0){var pp=((pf/inv)*100).toFixed(2);h+="<div style=\"display:flex;gap:8px;margin-top:10px;flex-wrap:wrap\"><div style=\"padding:8px 12px;border-radius:9px;background:rgba(255,255,255,.03);font-size:12px\"><span style=\"color:var(--t4)\">ì´ íˆ¬ì </span><span style=\"color:var(--t1);font-weight:600\">"+fSM(inv)+"</span></div><div style=\"padding:8px 12px;border-radius:9px;background:"+(pf>=0?"rgba(239,68,68,.06)":"rgba(59,130,246,.06)")+";font-size:12px\"><span style=\"color:var(--t4)\">ì´ ìˆ˜ìµ </span><span style=\"color:"+(pf>=0?"var(--red)":"var(--blue)")+";font-weight:700\">"+(pf>=0?"+":"")+fSM(pf)+" ("+(pf>=0?"+":"")+pp+"%)</span></div></div>"}
  if(!S.assets.length)h+="<div style=\"margin-top:12px;padding:11px 14px;background:rgba(255,255,255,.03);border-radius:11px;color:var(--t4);font-size:12.5px\">ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤. <span style=\"color:#60A5FA;cursor:pointer\" onclick=\"openAdd()\">+ ì¶”ê°€í•˜ê¸°</span></div>";
  h+="</div>";
  if(ac>0){h+="<div class=\"ai\"><div style=\"display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:9px\"><div><div style=\"font-size:13px;font-weight:700;color:var(--green)\">âš¡ ê°€ê²© ìë™ ìµœì‹ í™”</div><div style=\"font-size:11px;color:var(--t3);margin-top:2px\">"+ac+"ê°œ ì¢…ëª© í˜„ì¬ê°€ ìë™ ê²€ìƒ‰</div></div><button class=\"ai-btn\" onclick=\"autoAll()\""+(allLoading?" disabled":"")+">"+(allLoading?"<span class=\"spinner\"></span> ì—…ë°ì´íŠ¸ ì¤‘...":"âš¡ ì „ì²´ ìµœì‹ í™”")+"</button></div>";if(logs.length>0){h+="<div class=\"lgbox\">";logs.slice(0,6).forEach(function(l){h+="<div class=\"lgi"+(l.ok?"":" bad")+"\">"+(l.ok?"âœ…":"âŒ")+" <strong style=\"color:var(--t2)\">"+esc(l.name)+"</strong> "+(l.ok?fF(l.old)+" â†’ <span style=\"color:var(--green);font-weight:600\">"+fF(l.nu)+"</span>":(l.msg||"ì‹¤íŒ¨"))+"</div>"});h+="</div>"}h+="</div>"}
  var catColors=["#60A5FA","#A78BFA","#F472B6","#34D399","#FBBF24","#FB923C","#38BDF8","#E879F9","#818CF8","#4ADE80","#FB7185","#22D3EE"];
  var catBreakMap={};CATS.forEach(function(cat){var items=[];S.assets.filter(function(a){return a.category===cat&&ht(a)}).forEach(function(a){var v=gV(a);if(v>0)items.push({name:a.name,v:v})});if(items.length>=2){var ct=0;items.forEach(function(x){ct+=x.v});items.sort(function(a,b){return b.v-a.v});catBreakMap[cat]={items:items,total:ct}}});
  var prevCat=S.history.length>=2?S.history[S.history.length-2].byCategory:null;
  if(cd.length>0){h+="<div class=\"card\"><div style=\"font-size:14px;font-weight:700;color:var(--t1);margin-bottom:16px\">ìì‚° êµ¬ì„±</div><div style=\"display:flex;flex-wrap:wrap;gap:16px;align-items:center\"><div style=\"flex:0 0 180px;display:flex;justify-content:center\"><canvas id=\"cPie\" width=\"180\" height=\"180\"></canvas></div><div style=\"flex:1;min-width:160px\">";cd.forEach(function(d,i){var hasSub=!!catBreakMap[d.n];var isOpen=dashCatOpen[d.n];h+="<div style=\""+(i<cd.length-1?"border-bottom:1px solid rgba(255,255,255,.03);":"")+"\">";h+="<div style=\"display:flex;align-items:center;gap:9px;padding:8px 0;"+(hasSub?"cursor:pointer":"")+"\" "+(hasSub?"onclick=\"toggleDashCat("+Q+d.n+Q+")\"":"")+">" +"<div style=\"width:9px;height:9px;border-radius:3px;background:"+d.c+"\"></div><div style=\"flex:1;font-size:12.5px;color:var(--t2);font-weight:500\">"+d.ic+" "+d.n+(hasSub?" <span style=\"font-size:9px;color:var(--t5)\">"+(isOpen?"â–²":"â–¼")+"</span>":"")+"</div><div style=\"text-align:right\"><div style=\"font-size:13px;font-weight:700;color:var(--t1)\">"+fSM(d.v)+"</div><div style=\"font-size:10px;color:var(--t4)\">"+((d.v/total)*100).toFixed(1)+"%</div></div></div>";if(hasSub&&isOpen){var cb=catBreakMap[d.n];h+="<div style=\"padding:0 0 10px 18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center\"><div style=\"flex:0 0 110px;display:flex;justify-content:center\"><canvas id=\"cCat_"+i+"\" width=\"110\" height=\"110\"></canvas></div><div style=\"flex:1;min-width:100px\">";cb.items.forEach(function(it,ii){var clr=catColors[ii%catColors.length];h+="<div style=\"display:flex;align-items:center;gap:6px;padding:4px 0;"+(ii<cb.items.length-1?"border-bottom:1px solid rgba(255,255,255,.02)":"")+"\">"+"<div style=\"width:7px;height:7px;border-radius:2px;background:"+clr+"\"></div><div style=\"flex:1;font-size:11px;color:var(--t3);font-weight:500\">"+esc(it.name)+"</div><div style=\"text-align:right;font-size:11px\"><span style=\"font-weight:600;color:var(--t2)\">"+fSM(it.v)+"</span> <span style=\"color:var(--t5)\">"+((it.v/cb.total)*100).toFixed(1)+"%</span></div></div>"});h+="</div></div>"}h+="</div>"});h+="</div></div>";
  if(prevCat&&chg!==null&&chg!==0){var chgItems=[];cd.forEach(function(d){var cc=d.v-(prevCat[d.n]||0);if(cc!==0)chgItems.push({n:d.n,ic:d.ic,c:d.c,v:cc})});CATS.forEach(function(cat){if(prevCat[cat]&&prevCat[cat]>0&&!cd.some(function(d){return d.n===cat})){chgItems.push({n:cat,ic:CAT[cat].ic,c:CAT[cat].c,v:-prevCat[cat]})}});chgItems.sort(function(a,b){return Math.abs(b.v)-Math.abs(a.v)});if(chgItems.length>0){h+="<div style=\"margin-top:14px;padding:12px 14px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:11px\"><div style=\"font-size:11.5px;font-weight:600;color:var(--t3);margin-bottom:8px\">ğŸ“‹ ì „ì¼ ëŒ€ë¹„ ë³€ë™ ë‚´ì—­</div>";chgItems.forEach(function(ci){h+="<div style=\"display:flex;align-items:center;gap:8px;padding:4px 0\"><div style=\"width:7px;height:7px;border-radius:2px;background:"+ci.c+"\"></div><span style=\"flex:1;font-size:11.5px;color:var(--t3)\">"+ci.ic+" "+ci.n+"</span><span style=\"font-size:11.5px;font-weight:600;color:"+(ci.v>0?"var(--red)":"#60A5FA")+"\">"+(ci.v>0?"â–² +":"â–¼ ")+fSM(ci.v)+"</span></div>"});h+="</div>"}}
  h+="</div>"}
  if(cht.length>=2){h+="<div class=\"card\"><div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px\"><div style=\"font-size:14px;font-weight:700;color:var(--t1)\">ìì‚° ì¶”ì´</div><button style=\"background:none;border:none;color:#60A5FA;font-size:11.5px;cursor:pointer;font-weight:500;font-family:inherit\" onclick=\"goTab('hist')\">ìì„¸íˆ â†’</button></div><div style=\"position:relative;height:145px\"><canvas id=\"cL1\"></canvas></div></div>"}
  h+="</div>";el.innerHTML=h;if(cd.length>0)drawPie(cd,total);if(cht.length>=2)drawLine("cL1",cht,145);
  cd.forEach(function(d,i){if(dashCatOpen[d.n]&&catBreakMap[d.n]){setTimeout(function(){drawCatPie("cCat_"+i,catBreakMap[d.n].items,catBreakMap[d.n].total,catColors)},40)}})
}

function rList(){
  var el=document.getElementById("pgList"),ac=S.assets.filter(canAuto).length;
  var h="<div style=\"animation:fadeUp .4s ease\">";
  if(!S.assets.length){h+="<div class=\"card\" style=\"text-align:center;padding:50px 20px\"><div style=\"font-size:44px;margin-bottom:12px\">ğŸ’¼</div><div style=\"font-size:15px;font-weight:600;color:var(--t2);margin-bottom:5px\">ë“±ë¡ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤</div><button class=\"btn btn-p\" onclick=\"openAdd()\" style=\"margin-top:14px\">+ ìì‚° ì¶”ê°€</button></div>"}
  else{
    h+="<div style=\"display:flex;gap:8px;margin-bottom:12px\">";
    if(ac>0)h+="<button class=\"ai-btn\" style=\"flex:1;justify-content:center;background:linear-gradient(135deg,rgba(16,185,129,.07),rgba(59,130,246,.07));border:1px solid rgba(16,185,129,.1);color:var(--green);padding:12px;border-radius:13px\" onclick=\"autoAll()\""+(allLoading?" disabled":"")+">"+(allLoading?"<span class=\"spinner\"></span> ì—…ë°ì´íŠ¸ ì¤‘...":"âš¡ ì „ì²´ ê°€ê²© ìµœì‹ í™” ("+ac+"ê°œ)")+"</button>";
    h+="<button style=\"padding:12px 16px;border-radius:13px;border:1px solid "+(editMode?"rgba(59,130,246,.3)":"rgba(255,255,255,.08)")+";background:"+(editMode?"rgba(59,130,246,.1)":"rgba(255,255,255,.03)")+";color:"+(editMode?"#60A5FA":"var(--t3)")+";font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap\" onclick=\"toggleEdit()\">"+(editMode?"âœ“ ì™„ë£Œ":"â†• ìˆœì„œ í¸ì§‘")+"</button></div>";
    var ordCats=getCats();var usedCats=ordCats.filter(function(cat){return S.assets.filter(function(a){return a.category===cat}).length>0});
    usedCats.forEach(function(cat,catIdx){
      var ca=S.assets.filter(function(a){return a.category===cat});if(!ca.length)return;
      var ct=0;ca.forEach(function(a){ct+=gV(a)});
      if(editMode){
        h+="<div class=\"cg\"><div class=\"cg-h\" style=\"background:linear-gradient(90deg,"+CAT[cat].c+"06,transparent)\">";
        h+="<div style=\"display:flex;align-items:center;gap:8px\">";
        h+="<div style=\"display:flex;gap:3px\">";
        h+="<button style=\"border:none;background:"+(catIdx>0?"rgba(255,255,255,.08)":"rgba(255,255,255,.03)")+";color:"+(catIdx>0?"var(--t1)":"var(--t5)")+";width:26px;height:26px;border-radius:6px;cursor:"+(catIdx>0?"pointer":"default")+";font-size:11px;font-family:inherit;display:flex;align-items:center;justify-content:center\" onclick=\"moveCat("+Q+cat+Q+",-1)\""+(catIdx<=0?" disabled":"")+">â–²</button>";
        h+="<button style=\"border:none;background:"+(catIdx<usedCats.length-1?"rgba(255,255,255,.08)":"rgba(255,255,255,.03)")+";color:"+(catIdx<usedCats.length-1?"var(--t1)":"var(--t5)")+";width:26px;height:26px;border-radius:6px;cursor:"+(catIdx<usedCats.length-1?"pointer":"default")+";font-size:11px;font-family:inherit;display:flex;align-items:center;justify-content:center\" onclick=\"moveCat("+Q+cat+Q+",1)\""+(catIdx>=usedCats.length-1?" disabled":"")+">â–¼</button>";
        h+="</div>";
        h+="<span style=\"font-size:16px\">"+CAT[cat].ic+"</span><span style=\"font-size:13px;font-weight:700;color:var(--t1)\">"+cat+"</span><span style=\"font-size:10px;padding:2px 6px;border-radius:5px;font-weight:600;color:"+CAT[cat].c+";background:"+CAT[cat].c+"12\">"+ca.length+"ê°œ</span>";
        h+="</div><span style=\"font-size:11px;color:var(--t5);background:rgba(255,255,255,.03);padding:3px 8px;border-radius:5px\">"+(catIdx+1)+"/"+usedCats.length+"</span></div>";
      } else {
        var isCatOpen=catOpen[cat]!==false;
        h+="<div class=\"cg\"><div class=\"cg-h\" style=\"background:linear-gradient(90deg,"+CAT[cat].c+"06,transparent);cursor:pointer\" onclick=\"toggleCatOpen("+Q+cat+Q+")\"><div style=\"display:flex;align-items:center;gap:6px\"><span style=\"font-size:10px;color:var(--t4);transition:transform .2s;display:inline-block;transform:rotate("+(isCatOpen?"90":"0")+"deg)\">â–¶</span><span style=\"font-size:16px\">"+CAT[cat].ic+"</span><span style=\"font-size:13px;font-weight:700;color:var(--t1)\">"+cat+"</span><span style=\"font-size:10px;padding:2px 6px;border-radius:5px;font-weight:600;color:"+CAT[cat].c+";background:"+CAT[cat].c+"12\">"+ca.length+"ê°œ</span></div><span style=\"font-size:13px;font-weight:700;color:var(--t1)\">"+fSM(ct)+"</span></div>";
        if(!isCatOpen){h+="</div>";return}
        if(cat==="ì½”ì¸"){h+="<div style=\"padding:6px 16px 2px;display:flex;justify-content:flex-end\"><button style=\"border:none;background:rgba(255,255,255,.04);color:"+(S.coinShowPL?"var(--t3)":"var(--t4)")+";padding:4px 10px;border-radius:6px;font-size:10.5px;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px\" onclick=\"event.stopPropagation();S.coinShowPL=!S.coinShowPL;save();render()\">"+(S.coinShowPL?"ğŸ‘ ì†ìµ í‘œì‹œ ì¤‘":"ğŸ‘â€ğŸ—¨ ì†ìµ ìˆ¨ê¹€")+"</button></div>"}
      }
      ca.forEach(function(a,ai){
        var c=calcAsset(a),has=ht(a),canA=canAuto(a),ld=loading[a.id],isE=expanded[a.id];
        h+="<div class=\"ar\"><div style=\"width:100%\">";
        if(editMode){
          h+="<div style=\"display:flex;justify-content:space-between;align-items:center\">";
          h+="<div style=\"display:flex;align-items:center;gap:10px\"><div style=\"display:flex;flex-direction:column;gap:2px\">";
          h+="<button style=\"border:none;background:rgba(255,255,255,.06);color:"+(ai>0?"var(--t2)":"var(--t5)")+";width:28px;height:22px;border-radius:5px;cursor:"+(ai>0?"pointer":"default")+";font-size:12px;font-family:inherit\" onclick=\"moveAsset("+a.id+",-1)\""+(ai<=0?" disabled":"")+">â–²</button>";
          h+="<button style=\"border:none;background:rgba(255,255,255,.06);color:"+(ai<ca.length-1?"var(--t2)":"var(--t5)")+";width:28px;height:22px;border-radius:5px;cursor:"+(ai<ca.length-1?"pointer":"default")+";font-size:12px;font-family:inherit\" onclick=\"moveAsset("+a.id+",1)\""+(ai>=ca.length-1?" disabled":"")+">â–¼</button>";
          h+="</div><div><span style=\"font-size:13.5px;font-weight:600;color:var(--t2)\">"+esc(a.name)+"</span>";
          if(has&&c.qty>0)h+="<div style=\"font-size:11px;color:var(--t4);margin-top:1px\">"+fS(c.evalAmt)+"</div>";
          h+="</div></div>";
          h+="<span style=\"font-size:11px;color:var(--t5);background:rgba(255,255,255,.03);padding:3px 8px;border-radius:5px\">"+(ai+1)+"/"+ca.length+"</span></div>";
        } else {
        var isCL=isCashLike(a.category),hidePL=a.category==="ì½”ì¸"&&!S.coinShowPL;
        h+="<div style=\"display:flex;justify-content:space-between;align-items:center\"><div style=\"flex:1;min-width:0\">";
        h+="<div style=\"display:flex;align-items:center;flex-wrap:wrap;gap:3px\"><span style=\"font-size:13.5px;font-weight:600;color:var(--t2)\">"+esc(a.name)+"</span>"+(canA?"<span class=\"tag\" style=\"color:var(--green);background:rgba(16,185,129,.08)\">ìë™</span>":"")+(a.krxEtf?"<span class=\"tag\" style=\"color:#8B5CF6;background:rgba(139,92,246,.08)\">ğŸ‡°ğŸ‡· KRX</span>":"")+(a.isUsdt?"<span class=\"tag\" style=\"color:#10B981;background:rgba(16,185,129,.08)\">ğŸ’² USDT</span>":"")+"</div>";
        if(!has){h+="<div class=\"noth\">"+txL(a.category,"buy")+" ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ì´ ìì‚°ì— ë°˜ì˜ë©ë‹ˆë‹¤</div>"}
        if(ld)h+="<div style=\"font-size:10.5px;color:var(--amber);margin-top:2px;display:flex;align-items:center;gap:4px\"><span class=\"spinner sm\"></span> ê²€ìƒ‰ ì¤‘...</div>";
        h+="</div>";
        if(has&&c.qty>0){h+="<div style=\"text-align:right;flex-shrink:0;margin-left:8px\"><div style=\"font-size:14px;font-weight:700;color:var(--t1)\">"+fS(c.evalAmt)+"</div>";if(!isCL&&!hidePL){h+="<div style=\"font-size:11.5px;font-weight:600;color:"+(c.profit>=0?"var(--red)":"var(--blue)")+"\">"+(c.profit>=0?"+":"")+fS(c.profit)+" ("+(c.profit>=0?"+":"")+c.profitPct+"%)</div>"}h+="</div>"}
        else{h+="<div style=\"display:flex;gap:4px;align-items:center;flex-shrink:0;margin-left:8px\"><button class=\"btn-buy\" onclick=\"openTxn("+a.id+","+Q+"buy"+Q+")\">"+txL(a.category,"buy")+"</button><button class=\"ibtn\" style=\"background:rgba(255,255,255,.04);color:var(--t3)\" onclick=\"openEdit("+a.id+")\">âœï¸</button><button class=\"ibtn\" style=\"background:rgba(239,68,68,.05);color:var(--red)\" onclick=\"openDel("+a.id+")\">ğŸ—‘</button></div>"}
        h+="</div>";
        if(has&&c.qty>0){
          h+="<button class=\"dtgl\" onclick=\"toggleD("+a.id+")\">"+(isE?"â–² ì ‘ê¸°":"â–¼ ìƒì„¸ ì •ë³´")+"</button>";
          if(isE){
            h+="<div class=\"dsec\">";
            h+="<div style=\"display:flex;gap:6px;margin-bottom:12px\"><button class=\"btn-buy\" style=\"flex:1;text-align:center;padding:9px\" onclick=\"openTxn("+a.id+","+Q+"buy"+Q+")\">+ "+txL(a.category,"buy")+"</button><button class=\"btn-sell\" style=\"flex:1;text-align:center;padding:9px\" onclick=\"openTxn("+a.id+","+Q+"sell"+Q+")\">+ "+txL(a.category,"sell")+"</button><button class=\"ibtn\" style=\"background:rgba(255,255,255,.04);color:var(--t3)\" onclick=\"openEdit("+a.id+")\">âœï¸</button><button class=\"ibtn\" style=\"background:rgba(239,68,68,.05);color:var(--red)\" onclick=\"openDel("+a.id+")\">ğŸ—‘</button></div>";
            if(isCL){
              h+="<div class=\"dgrid\">";
              h+="<div class=\"ditem\"><div class=\"dl\">ì”ì•¡</div><div class=\"dv\">"+fS(c.evalAmt)+"</div></div>";
              h+="<div class=\"ditem\"><div class=\"dl\">ì…ì¶œê¸ˆ ë‚´ì—­</div><div class=\"dv\">"+(c.inCnt||0)+"ê±´ "+txL(a.category,"buy")+" / "+(c.outCnt||0)+"ê±´ "+txL(a.category,"sell")+"</div></div>";
              h+="</div>";
            } else {
              h+="<div class=\"dgrid\">";
              h+="<div class=\"ditem\"><div class=\"dl\">í˜„ì¬ê°€</div><div class=\"dv\">"+fF(a.amount)+"</div></div>";
              h+="<div class=\"ditem\"><div class=\"dl\">ë³´ìœ ìˆ˜ëŸ‰</div><div class=\"dv\">"+c.qty.toLocaleString()+txUnit(a.category)+"</div></div>";
              if(!hidePL){
                h+="<div class=\"ditem\"><div class=\"dl\">í‰ê· ë§¤ìˆ˜ë‹¨ê°€</div><div class=\"dv\">"+fF(c.avgPrice)+"</div></div>";
                h+="<div class=\"ditem\"><div class=\"dl\">ì´ íˆ¬ìê¸ˆì•¡</div><div class=\"dv\">"+fS(c.totalCost)+"</div></div>";
              }
              h+="<div class=\"ditem\"><div class=\"dl\">í‰ê°€ê¸ˆì•¡</div><div class=\"dv\">"+fS(c.evalAmt)+"</div></div>";
              if(!hidePL){h+="<div class=\"ditem\"><div class=\"dl\">ìˆ˜ìµ/ì†ì‹¤</div><div class=\"dv\" style=\"color:"+(c.profit>=0?"var(--red)":"var(--blue)")+"\">"+(c.profit>=0?"+":"")+fS(c.profit)+" ("+(c.profit>=0?"+":"")+c.profitPct+"%)</div></div>"}
              h+="</div>";
            }
            if(!isCL&&!hidePL&&c.accounts.length>1){h+="<div style=\"margin-top:12px;font-size:11.5px;color:var(--t3);font-weight:600;margin-bottom:6px\">ğŸ“Š ê³„ì¢Œë³„ í˜„í™©</div>";c.accounts.forEach(function(ac){h+="<div class=\"acr\"><div><span style=\"font-weight:600;color:var(--t2)\">"+esc(ac.name)+"</span> <span style=\"color:var(--t4)\">"+ac.qty+txUnit(a.category)+" Â· í‰ë‹¨ "+fF(ac.avgP)+"</span></div><div style=\"font-weight:600;color:"+(ac.profit>=0?"var(--red)":"var(--blue)")+"\">"+(ac.profit>=0?"+":"")+fS(ac.profit)+"</div></div>"})}
            if(a.lpu)h+="<div style=\"font-size:10px;color:var(--t5);margin-top:8px\">âš¡ "+a.lpu+"</div>";
            h+="<div style=\"margin-top:12px\"><div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:6px\"><span style=\"font-size:11.5px;color:var(--t3);font-weight:600\">ğŸ“‹ ìµœê·¼ ê±°ë˜</span><button style=\"background:none;border:none;color:#60A5FA;font-size:11px;cursor:pointer;font-family:inherit\" onclick=\"openTxnList("+a.id+")\">ì „ì²´ ë³´ê¸° â†’</button></div>";
            (a.txns||[]).slice().reverse().slice(0,3).forEach(function(t){h+="<div class=\"txr\"><span class=\"txt "+(t.type==="buy"?"txb":"txs")+"\">"+txL(a.category,t.type)+"</span><span style=\"color:var(--t2)\">"+fF(t.price)+"</span><span style=\"color:var(--t4)\">Ã—"+t.qty+"</span>"+(t.account?"<span class=\"txa\">"+esc(t.account)+"</span>":"")+"<span style=\"color:var(--t5);margin-left:auto;font-size:10px\">"+(t.date||"")+"</span></div>"});
            h+="</div></div>";
          }
        }
        }
        h+="</div></div>"});
      h+="</div>"});
    h+="<div style=\"margin-top:14px\"><button class=\"btn btn-p btn-w\" onclick=\"openAdd()\">+ ìƒˆ ìì‚° ì¶”ê°€</button></div>"}
  h+="</div>";el.innerHTML=h;
}

function rHist(){
  var el=document.getElementById("pgHist");var cht=S.history.slice(-30).map(function(h){return{d:h.date.slice(5),v:h.total}});
  var h="<div style=\"animation:fadeUp .4s ease\">";
  h+="<div style=\"display:flex;gap:8px;margin-bottom:14px\"><button class=\"btn btn-p\" style=\"flex:1;font-size:13px\" onclick=\"doSnap()\">ğŸ“¸ ì˜¤ëŠ˜ ê¸°ë¡ ì €ì¥</button></div>";
  if(cht.length<2){
    h+="<div class=\"card\" style=\"text-align:center;padding:40px 20px\"><div style=\"font-size:44px;margin-bottom:12px\">ğŸ“ˆ</div>";
    if(cht.length===0){h+="<div style=\"font-size:15px;font-weight:600;color:var(--t2);margin-bottom:5px\">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div><div style=\"font-size:12.5px;color:var(--t4)\">ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜¤ëŠ˜ì˜ ìì‚°ì„ ê¸°ë¡í•˜ì„¸ìš”</div>"}
    else{h+="<div style=\"font-size:15px;font-weight:600;color:var(--t2);margin-bottom:5px\">ì²« ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div><div style=\"font-size:12.5px;color:var(--t4);margin-bottom:14px\">ë‚´ì¼ ë‹¤ì‹œ ê¸°ë¡í•˜ë©´ ë³€ë™ ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</div><div style=\"padding:14px;border-radius:12px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.1)\"><div style=\"font-size:12px;color:var(--t3)\">"+S.history[0].date+"</div><div style=\"font-size:22px;font-weight:800;color:var(--t1);margin-top:4px\">"+fS(S.history[0].total)+"</div></div>"}
    h+="</div>"}
  else{h+="<div class=\"card\"><div style=\"font-size:14px;font-weight:700;color:var(--t1);margin-bottom:16px\">ìì‚° ë³€ë™ ì¶”ì´ (ìµœê·¼ 30ì¼)</div><div style=\"position:relative;height:230px\"><canvas id=\"cL2\"></canvas></div></div>";
    h+="<div class=\"card\"><div style=\"font-size:14px;font-weight:700;color:var(--t1);margin-bottom:12px\">ê¸°ë¡ ëª©ë¡</div>";
    S.history.slice().reverse().forEach(function(r){var idx=S.history.indexOf(r);var p=idx>0?S.history[idx-1]:null;var d=p?r.total-p.total:null;
      h+="<div class=\"hrow\"><div><div style=\"font-size:13px;font-weight:600;color:var(--t2)\">"+r.date+"</div></div><div style=\"text-align:right\"><div style=\"font-size:13px;font-weight:700;color:var(--t1)\">"+fS(r.total)+"</div>"+(d!==null?"<div style=\"font-size:11px;color:"+(d>=0?"var(--red)":"#60A5FA")+";font-weight:600\">"+(d>=0?"â–²":"â–¼")+" "+fS(Math.abs(d))+"</div>":"")+"</div></div>"});h+="</div>"}
  h+="<div style=\"margin-top:18px;padding:13px 16px;background:rgba(255,255,255,.015);border-radius:13px;border:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center\"><div><div style=\"font-size:12.5px;font-weight:600;color:var(--t3)\">ë°ì´í„° ê´€ë¦¬</div><div style=\"font-size:10.5px;color:var(--t5);margin-top:1px\">ê¸°ë¡ "+S.history.length+"ì¼ / ìì‚° "+S.assets.length+"ê±´</div></div><button class=\"btn btn-d\" style=\"font-size:11.5px;padding:7px 12px\" onclick=\"openReset()\">ğŸ—‘ ì´ˆê¸°í™”</button></div></div>";el.innerHTML=h;if(cht.length>=2)setTimeout(function(){drawLine("cL2",cht,230)},30);
}

function rAi(){
var el=document.getElementById("pgAi");var total=0,inv=0,byC={},items=[];CATS.forEach(function(c){byC[c]=0});
S.assets.forEach(function(a){var v=gV(a);total+=v;byC[a.category]+=v;var c=calcAsset(a);if(c.totalCost>0)inv+=c.totalCost;items.push({name:a.name,category:a.category,eval:v,cost:c.totalCost,profit:c.profit,profitPct:c.profitPct})});
items.sort(function(a,b){return b.eval-a.eval});
var g=S.goal;var h="<div class=\"card\"><div style=\"font-size:16px;font-weight:800;color:var(--t1);margin-bottom:4px\">ğŸ¯ ìì‚° ëª©í‘œ ì„¤ì •</div><div style=\"font-size:11.5px;color:var(--t4);margin-bottom:14px\">ëª©í‘œë¥¼ ì„¤ì •í•˜ë©´ ë‹¬ì„± ì‹œë®¬ë ˆì´ì…˜ê³¼ ì „ëµë„ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤</div>";
if(g){var pct=g.amount>0?Math.min((total/g.amount)*100,100):0;var remain=g.amount-total;var dLeft=g.date?Math.ceil((new Date(g.date)-new Date())/(86400000)):null;
h+="<div style=\"padding:14px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1);border-radius:12px;margin-bottom:12px\">";
h+="<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px\"><span style=\"font-size:12.5px;color:var(--t3)\">í˜„ì¬ "+fSM(total)+"</span><span style=\"font-size:12.5px;font-weight:700;color:var(--t1)\">ëª©í‘œ "+fSM(g.amount)+"</span></div>";
h+="<div style=\"height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden\"><div style=\"height:100%;width:"+pct+"%;background:linear-gradient(90deg,#3B82F6,#8B5CF6);border-radius:4px;transition:width .5s\"></div></div>";
h+="<div style=\"display:flex;justify-content:space-between;margin-top:6px\"><span style=\"font-size:11px;color:var(--t4)\">ë‹¬ì„±ë¥  "+pct.toFixed(1)+"%</span>";
if(remain>0)h+="<span style=\"font-size:11px;color:var(--t4)\">ë‚¨ì€ ê¸ˆì•¡ "+fSM(remain)+"</span>";
else h+="<span style=\"font-size:11px;color:var(--green);font-weight:600\">ğŸ‰ ëª©í‘œ ë‹¬ì„±!</span>";
h+="</div>";
if(dLeft!==null)h+="<div style=\"font-size:10.5px;color:var(--t5);margin-top:4px\">ğŸ“… ëª©í‘œì¼ "+g.date+" (D"+(dLeft>0?"-"+dLeft:dLeft===0?"-Day":"+"+(0-dLeft))+")</div>";
if(remain>0&&dLeft&&dLeft>0){var mLeft=Math.max(1,Math.ceil(dLeft/30));var monthly=Math.ceil(remain/mLeft);h+="<div style=\"margin-top:8px;padding:10px 12px;background:rgba(139,92,246,.06);border-radius:8px;font-size:11.5px;color:var(--t3)\">ğŸ’¡ ëª©í‘œ ë‹¬ì„±ê¹Œì§€ ë§¤ì›” ì•½ <strong style=\"color:var(--t1)\">"+fSM(monthly)+"</strong> ì¶”ê°€ í•„ìš” ("+mLeft+"ê°œì›”)</div>"}
h+="</div><button class=\"btn btn-g\" style=\"font-size:11.5px\" onclick=\"S.goal=null;save();rAi()\">ğŸ—‘ ëª©í‘œ ì´ˆê¸°í™”</button>"
}else{
h+="<div style=\"display:flex;gap:8px;flex-wrap:wrap\"><div class=\"fld\" style=\"flex:1;min-width:140px\"><label>ëª©í‘œ ê¸ˆì•¡</label><input type=\"number\" id=\"ai-goal-amt\" placeholder=\"ì˜ˆ: 500000000\" oninput=\"prevAmt(this.value)\"><div id=\"amt-prev\" style=\"font-size:12px;color:var(--green);font-weight:600;margin-top:4px;min-height:18px\"></div><div style=\"display:flex;gap:4px;flex-wrap:wrap;margin-top:6px\">";
["1ì–µ","3ì–µ","5ì–µ","10ì–µ","20ì–µ","50ì–µ"].forEach(function(lb){var vals={"1ì–µ":1e8,"3ì–µ":3e8,"5ì–µ":5e8,"10ì–µ":1e9,"20ì–µ":2e9,"50ì–µ":5e9};h+="<button style=\"border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--t3);padding:4px 10px;border-radius:7px;font-size:11px;cursor:pointer;font-family:inherit\" onclick=\"document.getElementById("+Q+"ai-goal-amt"+Q+").value="+vals[lb]+";prevAmt("+vals[lb]+")\">"+lb+"</button>"});
h+="</div></div><div class=\"fld\" style=\"flex:1;min-width:140px\"><label>ëª©í‘œ ë‚ ì§œ (ì„ íƒ)</label><input type=\"date\" id=\"ai-goal-date\"></div></div>";
h+="<button class=\"btn btn-p\" style=\"margin-top:8px\" onclick=\"setGoal()\">ğŸ¯ ëª©í‘œ ì„¤ì •í•˜ê¸°</button>"
}h+="</div>";
if(!S.assets.length){h+="<div class=\"card\" style=\"text-align:center;padding:30px;color:var(--t4);font-size:13px\">ìì‚°ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</div>";el.innerHTML=h;return}
h+="<div class=\"card\"><div style=\"font-size:16px;font-weight:800;color:var(--t1);margin-bottom:4px\">ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„</div><div style=\"font-size:11.5px;color:var(--t4);margin-bottom:14px\">ìì‚° ë°°ë¶„ê³¼ ë¶„ì‚°íˆ¬ì ìˆ˜ì¤€ì„ ì§„ë‹¨í•©ë‹ˆë‹¤</div>";
var activeCats=0,hhi=0;CATS.forEach(function(c){if(byC[c]>0){activeCats++;var w=byC[c]/total;hhi+=w*w}});
var divScore=activeCats<=1?10:activeCats===2?30:hhi<0.3?90:hhi<0.45?70:hhi<0.6?50:30;
var divLabel=divScore>=80?"ë§¤ìš° ìš°ìˆ˜":divScore>=60?"ì–‘í˜¸":divScore>=40?"ë³´í†µ":"ê°œì„  í•„ìš”";
var divColor=divScore>=60?"var(--green)":divScore>=40?"#FBBF24":"var(--red)";
h+="<div style=\"display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap\"><div style=\"flex:1;min-width:120px;padding:12px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.08);border-radius:10px;text-align:center\"><div style=\"font-size:10px;color:var(--t4)\">ë¶„ì‚°íˆ¬ì ì ìˆ˜</div><div style=\"font-size:24px;font-weight:800;color:"+divColor+"\">"+divScore+"<span style=\"font-size:12px\">/100</span></div><div style=\"font-size:11px;color:"+divColor+";font-weight:600\">"+divLabel+"</div></div>";
h+="<div style=\"flex:1;min-width:120px;padding:12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.08);border-radius:10px;text-align:center\"><div style=\"font-size:10px;color:var(--t4)\">í™œìš© ì¹´í…Œê³ ë¦¬</div><div style=\"font-size:24px;font-weight:800;color:var(--t1)\">"+activeCats+"<span style=\"font-size:12px\">/"+CATS.length+"</span></div><div style=\"font-size:11px;color:var(--t4)\">"+S.assets.length+"ê°œ ì¢…ëª© ë³´ìœ </div></div></div>";
h+="<div style=\"font-size:12.5px;font-weight:600;color:var(--t2);margin-bottom:8px\">ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘</div>";
CATS.forEach(function(cat){if(byC[cat]>0){var wp=((byC[cat]/total)*100);var warn=wp>60?"âš ï¸ ê³¼ë‹¤ ì§‘ì¤‘":"";h+="<div style=\"display:flex;align-items:center;gap:8px;margin-bottom:6px\"><span style=\"font-size:11.5px;color:var(--t3);min-width:70px\">"+CAT[cat].ic+" "+cat+"</span><div style=\"flex:1;height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden\"><div style=\"height:100%;width:"+wp+"%;background:"+CAT[cat].c+";border-radius:3px\"></div></div><span style=\"font-size:11px;color:var(--t2);font-weight:600;min-width:40px;text-align:right\">"+wp.toFixed(1)+"%</span>"+(warn?"<span style=\"font-size:10px;color:var(--red)\">"+warn+"</span>":"")+"</div>"}});
if(items.length>=2){h+="<div style=\"font-size:12.5px;font-weight:600;color:var(--t2);margin:14px 0 8px\">ìƒìœ„ ì¢…ëª© ì§‘ì¤‘ë„</div>";var top3=items.slice(0,3);top3.forEach(function(it,i){var wp=total>0?((it.eval/total)*100):0;h+="<div style=\"display:flex;align-items:center;gap:8px;margin-bottom:5px\"><span style=\"font-size:11px;color:var(--t4);min-width:18px\">"+(i+1)+".</span><span style=\"flex:1;font-size:11.5px;color:var(--t2)\">"+esc(it.name)+"</span><span style=\"font-size:11px;font-weight:600;color:var(--t1)\">"+wp.toFixed(1)+"%</span>"+(wp>40?"<span style=\"font-size:10px;color:var(--red)\">âš ï¸</span>":"")+"</div>"});var topPct=total>0?((top3.reduce(function(s,x){return s+x.eval},0)/total)*100):0;if(topPct>70)h+="<div style=\"font-size:10.5px;color:var(--red);margin-top:4px\">âš ï¸ ìƒìœ„ 3ê°œ ì¢…ëª©ì´ ì „ì²´ì˜ "+topPct.toFixed(0)+"%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤</div>"}
h+="</div>";
h+="<div class=\"card\"><div style=\"font-size:16px;font-weight:800;color:var(--t1);margin-bottom:4px\">âš ï¸ ë¦¬ìŠ¤í¬ ì§„ë‹¨</div><div style=\"font-size:11.5px;color:var(--t4);margin-bottom:14px\">í¬íŠ¸í´ë¦¬ì˜¤ ìœ„í—˜ ìš”ì†Œë¥¼ ì ê²€í•©ë‹ˆë‹¤</div>";
var risks=[];var cashPct=total>0?((byC["í˜„ê¸ˆ"]+byC["ì˜ˆì ê¸ˆ"])/total)*100:0;var coinPct=total>0?(byC["ì½”ì¸"]/total)*100:0;var stockPct=total>0?((byC["êµ­ë‚´ì£¼ì‹"]+byC["í•´ì™¸ì£¼ì‹"])/total)*100:0;
if(cashPct<10&&total>0)risks.push({lv:"warning",ic:"ğŸ›¡ï¸",t:"ì•ˆì „ìì‚° ë¹„ì¤‘ ë¶€ì¡±",d:"í˜„ê¸ˆ+ì˜ˆì ê¸ˆ ë¹„ì¤‘ì´ "+cashPct.toFixed(1)+"%ë¡œ ë‚®ìŠµë‹ˆë‹¤. ìµœì†Œ 10~20%ì˜ ì•ˆì „ìì‚°ì„ í™•ë³´í•˜ë©´ ê¸‰ë½ì¥ì—ì„œ ì‹¬ë¦¬ì  ì•ˆì •ê³¼ ì¶”ê°€ ë§¤ìˆ˜ ê¸°íšŒë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."});
if(coinPct>30)risks.push({lv:"danger",ic:"ğŸ¢",t:"ê³ ë³€ë™ì„± ìì‚° ê³¼ë‹¤",d:"ì½”ì¸ ë¹„ì¤‘ì´ "+coinPct.toFixed(1)+"%ì…ë‹ˆë‹¤. ë³€ë™ì„±ì´ ë§¤ìš° ë†’ì•„ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆì •ì„±ì„ í•´ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 20% ì´ë‚´ë¡œ ì¡°ì ˆì„ ê³ ë ¤í•´ë³´ì„¸ìš”."});
if(items.length>0&&total>0&&(items[0].eval/total)>0.5)risks.push({lv:"danger",ic:"ğŸ¯",t:"ë‹¨ì¼ ì¢…ëª© ì§‘ì¤‘ ìœ„í—˜",d:"\""+items[0].name+"\"ì´(ê°€) ì „ì²´ì˜ "+((items[0].eval/total)*100).toFixed(1)+"%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤. í•œ ì¢…ëª©ì— 50% ì´ìƒ ì§‘ì¤‘ì€ í° ë¦¬ìŠ¤í¬ì…ë‹ˆë‹¤."});
if(activeCats<=1&&S.assets.length>0)risks.push({lv:"danger",ic:"ğŸ“¦",t:"ìì‚° ìœ í˜• ë‹¨ì¼í™”",d:"ëª¨ë“  ìì‚°ì´ í•œ ì¹´í…Œê³ ë¦¬ì— ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì–‘í•œ ìì‚°êµ°ìœ¼ë¡œ ë¶„ì‚°í•˜ë©´ ìœ„í—˜ì´ í¬ê²Œ ì¤„ì–´ë“­ë‹ˆë‹¤."});
if(stockPct>0&&byC["êµ­ë‚´ì£¼ì‹"]>0&&byC["í•´ì™¸ì£¼ì‹"]>0){var domRatio=byC["êµ­ë‚´ì£¼ì‹"]/(byC["êµ­ë‚´ì£¼ì‹"]+byC["í•´ì™¸ì£¼ì‹"])*100;if(domRatio>80)risks.push({lv:"info",ic:"ğŸŒ",t:"êµ­ë‚´ í¸ì¤‘ (Home Bias)",d:"ì£¼ì‹ ì¤‘ êµ­ë‚´ ë¹„ì¤‘ì´ "+domRatio.toFixed(0)+"%ì…ë‹ˆë‹¤. í•´ì™¸ ë¶„ì‚° íˆ¬ìë¡œ ì§€ì—­ ë¦¬ìŠ¤í¬ë¥¼ ì¤„ì—¬ë³´ì„¸ìš”."})}else if(stockPct>0&&byC["í•´ì™¸ì£¼ì‹"]===0&&byC["êµ­ë‚´ì£¼ì‹"]>0)risks.push({lv:"info",ic:"ğŸŒ",t:"í•´ì™¸ íˆ¬ì ë¶€ì¬",d:"ì£¼ì‹ì´ êµ­ë‚´ì—ë§Œ ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê¸€ë¡œë²Œ ë¶„ì‚° íˆ¬ìë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”."});
var profitItems=items.filter(function(x){return x.cost>0&&x.profit!==0});var bigLoss=profitItems.filter(function(x){return x.profitPct<-20});
if(bigLoss.length>0)risks.push({lv:"warning",ic:"ğŸ“‰",t:"í° í­ ì†ì‹¤ ì¢…ëª© ë³´ìœ ",d:bigLoss.map(function(x){return x.name+"("+x.profitPct+"%)"}).join(", ")+"ì˜ ì†ì‹¤ì´ í½ë‹ˆë‹¤. ì†ì ˆ ë˜ëŠ” ë¬¼íƒ€ê¸° ì—¬ë¶€ë¥¼ ì‹ ì¤‘íˆ íŒë‹¨í•˜ì„¸ìš”."});
if(risks.length===0)risks.push({lv:"good",ic:"âœ…",t:"íŠ¹ë³„í•œ ìœ„í—˜ ìš”ì†Œ ì—†ìŒ",d:"í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ í° ë¦¬ìŠ¤í¬ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì •ê¸°ì ì¸ ë¦¬ë°¸ëŸ°ì‹±ì„ ê¶Œì¥í•©ë‹ˆë‹¤."});
risks.forEach(function(r){var bg=r.lv==="danger"?"rgba(239,68,68,.05)":r.lv==="warning"?"rgba(245,158,11,.05)":r.lv==="good"?"rgba(16,185,129,.05)":"rgba(59,130,246,.05)";var bd=r.lv==="danger"?"rgba(239,68,68,.12)":r.lv==="warning"?"rgba(245,158,11,.12)":r.lv==="good"?"rgba(16,185,129,.12)":"rgba(59,130,246,.12)";h+="<div style=\"padding:12px;background:"+bg+";border:1px solid "+bd+";border-radius:10px;margin-bottom:8px\"><div style=\"font-size:12.5px;font-weight:700;color:var(--t1);margin-bottom:3px\">"+r.ic+" "+r.t+"</div><div style=\"font-size:11.5px;color:var(--t3);line-height:1.6\">"+r.d+"</div></div>"});
h+="</div>";
h+="<div class=\"card\"><div style=\"font-size:16px;font-weight:800;color:var(--t1);margin-bottom:4px\">ğŸ’¡ ìì‚° ì¦ì‹ ì „ëµ</div><div style=\"font-size:11.5px;color:var(--t4);margin-bottom:14px\">í˜„ì¬ ìƒíƒœì— ë§ëŠ” ì‹¤í–‰ ê°€ëŠ¥í•œ ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤</div>";
var strats=[];
if(cashPct>40)strats.push({ic:"ğŸ’°",t:"ìœ íœ´ í˜„ê¸ˆ í™œìš©",d:"í˜„ê¸ˆ ë¹„ì¤‘ì´ "+cashPct.toFixed(0)+"%ë¡œ ë†’ìŠµë‹ˆë‹¤. ì¼ë¶€ë¥¼ ETF ì ë¦½ì‹ íˆ¬ì, CMA, ë˜ëŠ” ë‹¨ê¸° ì±„ê¶Œí˜• í€ë“œë¡œ ì˜®ê¸°ë©´ ì¸í”Œë ˆì´ì…˜ ë°©ì–´ì™€ ìˆ˜ìµì„ ë™ì‹œì— ë…¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤."});
if(activeCats<=2)strats.push({ic:"ğŸ”€",t:"ìì‚°êµ° ë‹¤ê°í™”",d:"í˜„ì¬ "+activeCats+"ê°œ ì¹´í…Œê³ ë¦¬ë§Œ í™œìš© ì¤‘ì…ë‹ˆë‹¤. ì£¼ì‹(êµ­ë‚´Â·í•´ì™¸), ì˜ˆì ê¸ˆ, ì½”ì¸ ë“±ìœ¼ë¡œ ë¶„ì‚°í•˜ë©´ í•œ ìì‚°êµ°ì˜ í•˜ë½ì´ ì „ì²´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."});
if(total>0&&!g)strats.push({ic:"ğŸ¯",t:"ëª©í‘œ ì„¤ì • ê¶Œì¥",d:"êµ¬ì²´ì ì¸ ê¸ˆì•¡ ëª©í‘œì™€ ê¸°í•œì„ ì„¤ì •í•˜ë©´ ë§¤ì›” í•„ìš”í•œ íˆ¬ìê¸ˆì„ ê³„ì‚°í•˜ê³  ì§„í–‰ ìƒí™©ì„ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ„ì˜ ëª©í‘œ ì„¤ì • ê¸°ëŠ¥ì„ í™œìš©í•´ë³´ì„¸ìš”."});
if(g&&g.amount>total){var rm=g.amount-total;var rates=[5,7,10];h+="<div style=\"font-size:12.5px;font-weight:600;color:var(--t2);margin-bottom:10px\">ğŸ“ˆ ì›”ë³„ ì ë¦½ ì‹œë®¬ë ˆì´ì…˜</div><div style=\"font-size:11px;color:var(--t4);margin-bottom:8px\">ëª©í‘œ "+fSM(g.amount)+" ë‹¬ì„±ì„ ìœ„í•œ ì˜ˆìƒ ê¸°ê°„</div>";
h+="<div style=\"display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px\">";
[500000,1000000,2000000,3000000].forEach(function(mp){h+="<div style=\"flex:1;min-width:110px;padding:10px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:9px;text-align:center\"><div style=\"font-size:10px;color:var(--t4)\">ì›” "+fSM(mp)+"</div>";rates.forEach(function(r){var mr=r/100/12;var months;if(mr>0){var x=(g.amount+mp/mr)/(total+mp/mr);if(x<=1)months=0;else months=Math.ceil(Math.log(x)/Math.log(1+mr))}else{months=Math.ceil(rm/mp)}if(months>600)months=999;var yy=Math.floor(months/12);var mm=months%12;h+="<div style=\"font-size:11px;margin-top:3px\"><span style=\"color:var(--t5)\">ì—° "+r+"%:</span> <span style=\"color:var(--t1);font-weight:600\">"+(months>=999?"50ë…„+":months===0?"ë‹¬ì„±":yy>0?yy+"ë…„ "+mm+"ê°œì›”":mm+"ê°œì›”")+"</span></div>"});h+="</div>"});
h+="</div>";
strats.push({ic:"ğŸ“Š",t:"ì ë¦½ì‹ íˆ¬ì í™œìš©",d:"ë§¤ì›” ì¼ì • ê¸ˆì•¡ì„ ì •í•´ì§„ ë‚ ì§œì— íˆ¬ìí•˜ëŠ” DCA(Dollar Cost Averaging) ì „ëµì€ ì‹œì¥ íƒ€ì´ë° ë¦¬ìŠ¤í¬ë¥¼ ì¤„ì—¬ì¤ë‹ˆë‹¤. ìœ„ ì‹œë®¬ë ˆì´ì…˜ì„ ì°¸ê³ í•˜ì—¬ ë³¸ì¸ì—ê²Œ ë§ëŠ” ì›” ì ë¦½ ê¸ˆì•¡ì„ ì„¤ì •í•´ë³´ì„¸ìš”."})}
if(coinPct>20)strats.push({ic:"âš–ï¸",t:"ë¦¬ë°¸ëŸ°ì‹± ê³ ë ¤",d:"ì½”ì¸ ë¹„ì¤‘("+coinPct.toFixed(0)+"%)ì´ ë†’ìŠµë‹ˆë‹¤. ìˆ˜ìµ ì‹¤í˜„ í›„ ì•ˆì „ìì‚°ì´ë‚˜ ETFë¡œ ë¶„ì‚°í•˜ë©´ ë³€ë™ì„±ì„ ì¤„ì´ë©´ì„œ ìˆ˜ìµì„ ë³´ì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."});
if(profitItems.length>0){var winners=profitItems.filter(function(x){return x.profitPct>30});if(winners.length>0)strats.push({ic:"ğŸ†",t:"ìˆ˜ìµ ì‹¤í˜„ ê²€í† ",d:winners.map(function(x){return x.name+"(+"+x.profitPct+"%)"}).join(", ")+"ì´ í° ìˆ˜ìµ êµ¬ê°„ì…ë‹ˆë‹¤. ì¼ë¶€ ì°¨ìµ ì‹¤í˜„ í›„ ì¬íˆ¬ìí•˜ë©´ ë¦¬ìŠ¤í¬ë¥¼ ê´€ë¦¬í•˜ë©´ì„œ ë³µë¦¬ íš¨ê³¼ë¥¼ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."})}
if(strats.length===0)strats.push({ic:"ğŸ‘",t:"í˜„ì¬ ì˜ ìš´ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤",d:"í¬íŠ¸í´ë¦¬ì˜¤ê°€ ê· í˜• ì¡í˜€ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ì „ëµì„ ìœ ì§€í•˜ë©´ì„œ ì •ê¸°ì ìœ¼ë¡œ ë¦¬ë°¸ëŸ°ì‹±í•˜ê³ , ì‹œì¥ ìƒí™©ì— ë”°ë¼ ë¹„ì¤‘ì„ ë¯¸ì„¸ ì¡°ì •í•˜ì„¸ìš”."});
strats.forEach(function(s){h+="<div style=\"padding:12px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:10px;margin-bottom:8px\"><div style=\"font-size:12.5px;font-weight:700;color:var(--t1);margin-bottom:3px\">"+s.ic+" "+s.t+"</div><div style=\"font-size:11.5px;color:var(--t3);line-height:1.6\">"+s.d+"</div></div>"});
h+="</div>";
h+="<div class=\"card\"><div style=\"font-size:16px;font-weight:800;color:var(--t1);margin-bottom:4px\">ğŸ¤– AI ì»¨ì„¤í„´íŠ¸ <span style=\"font-size:12px;font-weight:500;color:#60A5FA\">(Gemini 3 Flash)</span></div><div style=\"font-size:11.5px;color:var(--t4);margin-bottom:14px\">í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIì—ê²Œ ììœ ë¡­ê²Œ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>";
var gk=getGemKey();
if(!gk){h+="<div style=\"padding:16px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.1);border-radius:12px\"><div style=\"font-size:12.5px;font-weight:600;color:var(--t2);margin-bottom:8px\">ğŸ”‘ Gemini API í‚¤ ì„¤ì •</div><div style=\"font-size:11.5px;color:var(--t4);margin-bottom:10px\">Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div><div style=\"display:flex;gap:6px\"><input id=\"gem-key\" type=\"password\" placeholder=\"AIzaSy...\" style=\"flex:1\"><button class=\"btn btn-p\" style=\"flex-shrink:0;padding:0 14px\" onclick=\"saveGemKey()\">ì €ì¥</button></div><div class=\"ht\" style=\"margin-top:6px\">í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div></div>"}
else{h+="<div style=\"display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px\"><button class=\"btn btn-p\" style=\"font-size:12px\" onclick=\"askGem('analyze')\" "+(gemLoading?"disabled":"")+">ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„</button><button class=\"btn\" style=\"font-size:12px;background:rgba(139,92,246,.1);color:#A78BFA;border:1px solid rgba(139,92,246,.15)\" onclick=\"askGem('strategy')\" "+(gemLoading?"disabled":"")+">ğŸ’¡ ì¦ì‹ ì „ëµ</button><button class=\"btn\" style=\"font-size:12px;background:rgba(16,185,129,.1);color:var(--green);border:1px solid rgba(16,185,129,.15)\" onclick=\"askGem('risk')\" "+(gemLoading?"disabled":"")+">âš ï¸ ë¦¬ìŠ¤í¬ ì§„ë‹¨</button><button class=\"btn\" style=\"font-size:12px;background:rgba(245,158,11,.1);color:#FBBF24;border:1px solid rgba(245,158,11,.15)\" onclick=\"askGem('rebalance')\" "+(gemLoading?"disabled":"")+">âš–ï¸ ë¦¬ë°¸ëŸ°ì‹±</button></div>";
h+="<div style=\"display:flex;gap:6px;margin-bottom:12px\"><input id=\"gem-q\" placeholder=\"ì˜ˆ: ì›” 200ë§Œì› íˆ¬ìí•˜ë©´ 5ì–µê¹Œì§€ ì–¼ë§ˆë‚˜ ê±¸ë ¤?\" style=\"flex:1\" onkeydown=\"if(event.key==='Enter')askGem('custom')\"><button class=\"btn btn-p\" style=\"flex-shrink:0;padding:0 14px\" onclick=\"askGem('custom')\" "+(gemLoading?"disabled":"")+">ì „ì†¡</button></div>";
if(gemLoading)h+="<div style=\"text-align:center;padding:30px\"><span class=\"spinner\"></span><div style=\"font-size:12px;color:var(--t4);margin-top:10px\">Gemini 3 Flashê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div></div>";
else if(gemResult)h+="<div style=\"padding:16px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:12px;line-height:1.75\"><div style=\"font-size:11px;color:var(--t5);margin-bottom:8px\">ğŸ¤– Gemini 3 Flash ë¶„ì„ ê²°ê³¼</div><div style=\"font-size:13px;color:var(--t2);white-space:pre-wrap\">"+fmtGem(gemResult)+"</div></div>";
h+="<div style=\"margin-top:8px;text-align:right\"><button style=\"background:none;border:none;color:var(--t5);font-size:10.5px;cursor:pointer;font-family:inherit\" onclick=\"clearGemKey()\">ğŸ”‘ API í‚¤ ë³€ê²½</button></div>"}
h+="</div>";
h+="<div style=\"padding:10px 14px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.1);border-radius:10px;font-size:10.5px;color:var(--t4)\">âš ï¸ ë¶„ì„ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, íˆ¬ì íŒë‹¨ì€ ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤. ì „ë¬¸ì ì¸ íˆ¬ì ìƒë‹´ì€ ê³µì¸ ì¬ë¬´ì„¤ê³„ì‚¬ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>";
el.innerHTML=h}
function setGoal(){var amt=Number((document.getElementById("ai-goal-amt")||{}).value);var dt=(document.getElementById("ai-goal-date")||{}).value||null;if(!amt||amt<=0)return;S.goal={amount:amt,date:dt,setDate:toDay()};save();rAi()}
function prevAmt(v){var el=document.getElementById("amt-prev");if(!el)return;var n=Number(v);if(!n||n<=0){el.textContent="";return}el.textContent="â†’ "+fS(n)}
function getGemKey(){try{return localStorage.getItem("gem_api_key")||""}catch(e){return""}}
function saveGemKey(){var k=((document.getElementById("gem-key")||{}).value||"").trim();if(!k)return;try{localStorage.setItem("gem_api_key",k)}catch(e){}showToast("âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");rAi()}
function clearGemKey(){try{localStorage.removeItem("gem_api_key")}catch(e){}gemResult=null;showToast("ğŸ”‘ API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");rAi()}
function fmtGem(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong style=\"color:var(--t1)\">$1</strong>").replace(/^### (.+)$/gm,"<div style=\"font-size:14px;font-weight:700;color:var(--t1);margin:12px 0 6px\">$1</div>").replace(/^## (.+)$/gm,"<div style=\"font-size:15px;font-weight:800;color:var(--t1);margin:14px 0 6px\">$1</div>")}
function buildPort(){var total=0,byC={},its=[];CATS.forEach(function(c){byC[c]=0});S.assets.forEach(function(a){var v=gV(a);total+=v;byC[a.category]+=v;var c=calcAsset(a);its.push({name:a.name,category:a.category,eval:v,cost:c.totalCost,profit:c.profit,profitPct:c.profitPct})});var cs=[];for(var k in byC){if(byC[k]>0)cs.push(k+": "+fSM(byC[k])+" ("+((byC[k]/total)*100).toFixed(1)+"%)")}var t="ì´ ìì‚°: "+fSM(total)+"\nì¹´í…Œê³ ë¦¬ë³„: "+cs.join(", ")+"\nì¢…ëª© ìˆ˜: "+its.length+"ê°œ";its.forEach(function(x){t+="\n- "+x.name+" ("+x.category+"): í‰ê°€ "+fSM(x.eval)+(x.cost>0?", íˆ¬ì "+fSM(x.cost)+", ìˆ˜ìµë¥  "+x.profitPct+"%":"")});if(S.goal)t+="\nëª©í‘œ: "+fSM(S.goal.amount)+(S.goal.date?" ("+S.goal.date+" ê¹Œì§€)":"");if(S.history.length>=2){var h1=S.history[S.history.length-2],h2=S.history[S.history.length-1];t+="\nì „ì¼ ë³€ë™: "+fSM(h2.total-h1.total)}return t}
function askGem(mode){var q="";if(mode==="custom"){q=((document.getElementById("gem-q")||{}).value||"").trim();if(!q)return}var gk=getGemKey();if(!gk)return;var port=buildPort();var sys="ë‹¹ì‹ ì€ í•œêµ­ì–´ ê°œì¸ ìì‚°ê´€ë¦¬ AI ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ì í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì¡°ì–¸í•˜ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì„œë¡ ì´ë‚˜ ì¸ì‚¬ ì—†ì´ ë°”ë¡œ ë³¸ë¡ ìœ¼ë¡œ, 300ì ì´ë‚´ë¡œ ë‹µë³€í•˜ì„¸ìš”. **ë³¼ë“œ**ì™€ ### í—¤ë”©ì„ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš”. íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹Œ ì •ë³´ ì œê³µì…ë‹ˆë‹¤.";var um="";if(mode==="analyze")um="ë‹¤ìŒ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì¢…í•© ë¶„ì„í•´ì£¼ì„¸ìš”. ìì‚° ë°°ë¶„ í‰ê°€, ë¶„ì‚°íˆ¬ì ìˆ˜ì¤€, ê°•ì ê³¼ ì•½ì , ê°œì„  ë°©í–¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.\n\n"+port;else if(mode==="strategy")um="ë‹¤ìŒ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë³´ê³  ìì‚°ì„ íš¨ê³¼ì ìœ¼ë¡œ ë¶ˆë ¤ë‚˜ê°€ê¸° ìœ„í•œ êµ¬ì²´ì  ì „ëµì„ ì œì•ˆí•´ì£¼ì„¸ìš”. ë¦¬ë°¸ëŸ°ì‹± ë°©í–¥, ì¶”ê°€ íˆ¬ì ì¢…ëª©/ì¹´í…Œê³ ë¦¬ ì¶”ì²œ, ì›” ì ë¦½ ì „ëµ, ì‹œì¥ ìƒí™© ê³ ë ¤ì‚¬í•­ì„ í¬í•¨í•´ì£¼ì„¸ìš”.\n\n"+port;else if(mode==="risk")um="ë‹¤ìŒ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ë¦¬ìŠ¤í¬ë¥¼ ì •ë°€ ì§„ë‹¨í•´ì£¼ì„¸ìš”. ì§‘ì¤‘ë„ ìœ„í—˜, ë³€ë™ì„±, ë°©ì–´ ìì‚° ë¶€ì¡±, ì‹œì¥/í™˜ìœ¨ ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•˜ê³  êµ¬ì²´ì  ì™„í™” ë°©ì•ˆì„ ì œì•ˆí•´ì£¼ì„¸ìš”.\n\n"+port;else if(mode==="rebalance")um="ë‹¤ìŒ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìµœì  ë¦¬ë°¸ëŸ°ì‹± ë°©ì•ˆì„ ì œì•ˆí•´ì£¼ì„¸ìš”. ê° ì¹´í…Œê³ ë¦¬ì˜ ëª©í‘œ ë¹„ì¤‘, êµ¬ì²´ì ìœ¼ë¡œ ëŠ˜ë¦´/ì¤„ì¼ ë¶€ë¶„, ì‹¤í–‰ ìˆœì„œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.\n\n"+port;else um="í¬íŠ¸í´ë¦¬ì˜¤:\n"+port+"\n\nì§ˆë¬¸: "+q;
gemLoading=true;gemResult=null;rAi();
fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key="+gk,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:sys+"\n\n"+um}]}],generationConfig:{maxOutputTokens:2048}})}).then(function(r){return r.json()}).then(function(d){gemLoading=false;if(d&&d.candidates&&d.candidates[0]&&d.candidates[0].content){gemResult=d.candidates[0].content.parts.map(function(p){return p.text||""}).join("\n");if(d.candidates[0].finishReason==="MAX_TOKENS")gemResult+="\n\nâš ï¸ ì‘ë‹µì´ ê¸¸ì–´ì„œ ì¼ë¶€ê°€ ì˜ë ¸ìŠµë‹ˆë‹¤. ë” êµ¬ì²´ì ì¸ ì§ˆë¬¸ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”."}else if(d&&d.error){gemResult="âŒ ì˜¤ë¥˜: "+(d.error.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")}else{gemResult="ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."}rAi()}).catch(function(e){gemLoading=false;gemResult="âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: "+e.message;rAi()})}
function drawPie(data,total){var ctx=document.getElementById("cPie");if(!ctx)return;if(charts.pie)charts.pie.destroy();charts.pie=new Chart(ctx,{type:"doughnut",data:{labels:data.map(function(d){return d.ic+" "+d.n}),datasets:[{data:data.map(function(d){return d.v}),backgroundColor:data.map(function(d){return d.c}),borderWidth:0,spacing:2}]},options:{cutout:"62%",responsive:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"#1A1D23",borderColor:"rgba(255,255,255,.1)",borderWidth:1,titleFont:{family:"Pretendard Variable",size:12},bodyFont:{family:"Pretendard Variable",size:12},callbacks:{label:function(c){return c.label+": "+fF(c.raw)+" ("+((c.raw/total)*100).toFixed(1)+"%)"}}}}},plugins:[{id:"ct",afterDraw:function(ch){var c=ch.ctx,w=ch.width,hh=ch.height;c.save();c.textAlign="center";c.fillStyle="#94A3B8";c.font="10px Pretendard Variable";c.fillText("ì´ ìì‚°",w/2,hh/2-5);c.fillStyle="#F1F5F9";c.font="bold 13px Pretendard Variable";c.fillText(fSM(total),w/2,hh/2+11);c.restore()}}]})}
function drawCatPie(id,items,total,colors){var ctx=document.getElementById(id);if(!ctx)return;if(charts.catPies[id])charts.catPies[id].destroy();charts.catPies[id]=new Chart(ctx,{type:"doughnut",data:{labels:items.map(function(d){return d.name}),datasets:[{data:items.map(function(d){return d.v}),backgroundColor:items.map(function(d,i){return colors[i%colors.length]}),borderWidth:0,spacing:2}]},options:{cutout:"58%",responsive:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"#1A1D23",borderColor:"rgba(255,255,255,.1)",borderWidth:1,titleFont:{family:"Pretendard Variable",size:11},bodyFont:{family:"Pretendard Variable",size:11},callbacks:{label:function(c){return c.label+": "+fSM(c.raw)+" ("+((c.raw/total)*100).toFixed(1)+"%)"}}}}},plugins:[{id:"ct2",afterDraw:function(ch){var c=ch.ctx,w=ch.width,hh=ch.height;c.save();c.textAlign="center";c.fillStyle="#94A3B8";c.font="9px Pretendard Variable";c.fillText(items.length+"ì¢…ëª©",w/2,hh/2-4);c.fillStyle="#F1F5F9";c.font="bold 11px Pretendard Variable";c.fillText(fSM(total),w/2,hh/2+10);c.restore()}}]})}function drawLine(id,data,h){var ctx=document.getElementById(id);if(!ctx)return;var key=id==="cL1"?"l1":"l2";if(charts[key])charts[key].destroy();var g=ctx.getContext("2d").createLinearGradient(0,0,0,h);g.addColorStop(0,"rgba(59,130,246,.2)");g.addColorStop(1,"rgba(59,130,246,0)");charts[key]=new Chart(ctx,{type:"line",data:{labels:data.map(function(d){return d.d}),datasets:[{data:data.map(function(d){return d.v}),borderColor:"#3B82F6",borderWidth:2.5,backgroundColor:g,fill:true,pointRadius:data.length>15?2:3,pointBackgroundColor:"#3B82F6",tension:.35}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{color:"rgba(255,255,255,.03)"},ticks:{color:"#475569",font:{size:10,family:"Pretendard Variable"}},border:{display:false}},y:{grid:{color:"rgba(255,255,255,.03)"},ticks:{color:"#475569",font:{size:10,family:"Pretendard Variable"},callback:function(v){return fSM(v)}},border:{display:false}}},plugins:{legend:{display:false},tooltip:{backgroundColor:"#1A1D23",borderColor:"rgba(255,255,255,.1)",borderWidth:1,titleFont:{family:"Pretendard Variable"},bodyFont:{family:"Pretendard Variable"},callbacks:{label:function(c){return fF(c.raw)}}}}}})}

function autoAll(){var up=S.assets.filter(canAuto);if(!up.length)return;if(isSandbox){logs=[];up.forEach(function(a){logs.push({name:a.name,ok:false,msg:"ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ - ë‹¤ìš´ë¡œë“œ í›„ ì‚¬ìš©"})});render();return}allLoading=true;logs=[];render();var coins=up.filter(function(a){return a.category==="ì½”ì¸"&&a.coinId});var stocks=up.filter(function(a){return(a.category==="êµ­ë‚´ì£¼ì‹"||a.category==="í•´ì™¸ì£¼ì‹")&&a.stockCode});fetchCoinPrices(coins.map(function(a){return a.coinId})).then(function(prices){coins.forEach(function(a){var d=prices[a.coinId];if(d&&d.krw){var old=a.amount;a.amount=d.krw;a.lpu=toNow();logs.push({name:a.name,old:old,nu:d.krw,ok:true})}else{logs.push({name:a.name,ok:false,msg:"ì‘ë‹µ ì—†ìŒ"})}});render();var i=0;function nx(){if(i>=stocks.length){S.history=mkSnap(S.assets,S.history);save();allLoading=false;render();return}var a=stocks[i++];loading[a.id]=true;render();fetchSP(a).then(function(p){loading[a.id]=false;if(p&&p>0){var old=a.amount;a.amount=p;a.lpu=toNow();logs.push({name:a.name,old:old,nu:p,ok:true})}else{logs.push({name:a.name,ok:false,msg:"ì‘ë‹µ ì—†ìŒ"})}render();setTimeout(nx,600)})}nx()})}

function openM(t,b){document.getElementById("mTi").textContent=t;document.getElementById("mBd").innerHTML=b;document.getElementById("mBg").classList.remove("hidden")}
function closeM(){document.getElementById("mBg").classList.add("hidden")}
function openTxn(aid,type){var a=null;S.assets.forEach(function(x){if(x.id===aid)a=x});if(!a)return;var accs={};(a.txns||[]).forEach(function(t){if(t.account)accs[t.account]=1});var al=Object.keys(accs);var isF=a.category==="í•´ì™¸ì£¼ì‹"||a.category==="ì½”ì¸";var isCL=isCashLike(a.category);var isU=a.isUsdt;var lbl=txL(a.category,type);var h="";if(isF){h+="<div class=\"fld\"><label>í†µí™” ì„ íƒ</label><div class=\"mkt-sel\"><button class=\"mkt-opt sel\" id=\"cur-krw\" onclick=\"selCur("+Q+"KRW"+Q+")\">ğŸ‡°ğŸ‡· ì›í™”(KRW)</button><button class=\"mkt-opt\" id=\"cur-usd\" onclick=\"selCur("+Q+"USD"+Q+")\">ğŸ‡ºğŸ‡¸ ë‹¬ëŸ¬(USD)</button></div><input type=\"hidden\" id=\"tx-cur\" value=\"KRW\"><div id=\"tx-rate\" style=\"font-size:10.5px;color:var(--t5);margin-top:4px\">ğŸ’± í˜„ì¬ í™˜ìœ¨: "+(cachedRate&&cachedRate.r?Math.round(cachedRate.r).toLocaleString()+"ì›/$ âœ“":"ì¡°íšŒ ì¤‘...")+"</div></div>"}if(isU){h+="<div class=\"fld\"><label>ğŸ’² "+lbl+" USDT ìˆ˜ëŸ‰</label><input type=\"number\" id=\"tx-uq\" step=\"any\" placeholder=\"ì˜ˆ: 500\" oninput=\"updUsdtCv()\"><div id=\"tx-usdt-rate\" style=\"font-size:10.5px;color:var(--t5);margin-top:4px\">ğŸ’± USDT ì‹œì„¸ ì¡°íšŒ ì¤‘... (ì—…ë¹„íŠ¸/ë¹—ì¸ ê¹€í”„ ë°˜ì˜)</div><div id=\"tx-usdt-cv\" style=\"font-size:12px;color:var(--t2);margin-top:4px;font-weight:600\"></div></div><input type=\"hidden\" id=\"tx-p\" value=\"0\">"}else{h+="<div class=\"fld\"><label>"+(isCL?lbl+" ê¸ˆì•¡":lbl+" ë‹¨ê°€")+" "+(isF?"":"(ì›)")+"</label><input type=\"number\" id=\"tx-p\" oninput=\"updCv()\" placeholder=\""+(isCL?"ê¸ˆì•¡":"1ì£¼ë‹¹ ê°€ê²©")+"\""+(a.amount&&!isCL?" value=\""+a.amount+"\"":"")+">"+"<div id=\"tx-kp\" style=\"font-size:12px;color:var(--green);font-weight:600;margin-top:3px;min-height:16px\">"+(a.amount&&!isCL?"â†’ "+fS(a.amount):"")+"</div>"+(isF?"<div id=\"tx-cv\" style=\"font-size:10.5px;color:var(--t4);margin-top:1px\"></div>":"")+"</div>"}if(!isCL&&!isU){h+="<div class=\"fld\"><label>ìˆ˜ëŸ‰</label><input type=\"number\" id=\"tx-q\" placeholder=\"ìˆ˜ëŸ‰\" value=\"1\" step=\"any\"></div>"}h+="<div class=\"fld\"><label>"+(isCL?"ê³„ì¢Œëª…":"ê³„ì¢Œëª… (ì„ íƒ)")+"</label><input id=\"tx-a\" placeholder=\""+(isU?"ì˜ˆ: ì—…ë¹„íŠ¸, ë¹—ì¸":isCL?"ì˜ˆ: ë†í˜‘ì€í–‰, ì¹´ì¹´ì˜¤ë±…í¬":"ì˜ˆ: í‚¤ì›€ì¦ê¶Œ, ì‚¼ì„±ì¦ê¶Œ")+"\">";if(al.length>0){h+="<div style=\"margin-top:5px;display:flex;gap:4px;flex-wrap:wrap\">";al.forEach(function(ac){h+="<button class=\"cchip\" style=\"padding:3px 8px\" onclick=\"document.getElementById("+Q+"tx-a"+Q+").value="+Q+esc(ac)+Q+"\">"+esc(ac)+"</button>"});h+="</div>"}h+="</div><div class=\"fld\"><label>ë‚ ì§œ</label><input type=\"date\" id=\"tx-d\" value=\""+toDay()+"\"></div>";h+="<div class=\"fld\"><label>ë©”ëª¨ (ì„ íƒ)</label><input id=\"tx-m\" placeholder=\"ë©”ëª¨\"></div>";h+="<div class=\"mbtn\"><button class=\"btn btn-g\" onclick=\"closeM()\">ì·¨ì†Œ</button><button class=\"btn "+(type==="buy"?"btn-p":"btn-d")+"\" style=\"flex:2\" onclick=\"doTxn("+aid+","+Q+type+Q+")\">ê¸°ë¡í•˜ê¸°</button></div>";openM(a.name+" "+lbl,h);if(isF&&(!cachedRate||!cachedRate.r)){getRate().then(function(rt){var re=document.getElementById("tx-rate");if(re)re.innerHTML="ğŸ’± í˜„ì¬ í™˜ìœ¨: "+Math.round(rt).toLocaleString()+"ì›/$ âœ“"})}if(isU){getUsdtRate().then(function(rt){var src=cachedUsdt&&cachedUsdt.src?cachedUsdt.src:"";var re=document.getElementById("tx-usdt-rate");if(re)re.innerHTML="ğŸ’± 1 USDT â‰ˆ "+Math.round(rt)+"ì›"+(src?" ("+src+" ì‹¤ì‹œê°„)":"")})}}
function selCur(c){var a=document.getElementById("cur-krw"),b=document.getElementById("cur-usd"),h=document.getElementById("tx-cur");if(a)a.classList.toggle("sel",c==="KRW");if(b)b.classList.toggle("sel",c==="USD");if(h)h.value=c;updCv()}
function updCv(){var cv=document.getElementById("tx-cv"),cur=document.getElementById("tx-cur"),pi=document.getElementById("tx-p"),kp=document.getElementById("tx-kp");if(pi){var pv=Number(pi.value);if(kp){kp.textContent=pv>0?"â†’ "+fS(pv):""}};if(!cv||!cur||!pi)return;var p=Number(pi.value);if(cur.value==="USD"&&p>0){getRate().then(function(rt){var krw=Math.round(p*rt);cv.innerHTML="â‰ˆ "+fF(krw)+" <span style=\"color:var(--t5)\">(1$ â‰ˆ "+Math.round(rt).toLocaleString()+"ì›"+(cachedRate&&cachedRate.r?" âœ“":"")+")</span>"})}else{cv.textContent=""}}
function updUsdtCv(){var uq=document.getElementById("tx-uq"),cv=document.getElementById("tx-usdt-cv"),hp=document.getElementById("tx-p");if(!uq||!cv)return;var q=Number(uq.value);if(q>0){getUsdtRate().then(function(rt){var krw=Math.round(q*rt);var src=cachedUsdt&&cachedUsdt.src?cachedUsdt.src:"";cv.innerHTML="â‰ˆ "+fF(krw)+" ì›í™” í™˜ì‚°"+(src?" ("+src+")":"");if(hp)hp.value=krw})}else{cv.textContent="";if(hp)hp.value="0"}}
function refreshRate(){cachedRate=null;showToast("ğŸ”„ í™˜ìœ¨ ìµœì‹ í™” ì¤‘...");fetchRate().then(function(r){showToast("ğŸ’± í™˜ìœ¨ ì—…ë°ì´íŠ¸: 1$ = "+Math.round(r).toLocaleString()+"ì›");render()})}
function getUsdtRate(){if(cachedUsdt&&Date.now()-cachedUsdt.t<600000)return Promise.resolve(cachedUsdt.r);return fetchUsdtRate()}
function fetchUsdtRate(){
  return fetch("https://api.upbit.com/v1/ticker?markets=KRW-USDT").then(function(r){if(!r.ok)throw new Error(r.status);return r.json()}).then(function(d){if(d&&d[0]&&d[0].trade_price){cachedUsdt={r:d[0].trade_price,t:Date.now(),src:"ì—…ë¹„íŠ¸"};return d[0].trade_price}throw new Error("no data")})
  .catch(function(){return fetch("https://api.bithumb.com/public/ticker/USDT_KRW").then(function(r){return r.json()}).then(function(d){if(d&&d.data&&d.data.closing_price){var p=Number(d.data.closing_price);cachedUsdt={r:p,t:Date.now(),src:"ë¹—ì¸"};return p}throw new Error("no data")})})
  .catch(function(){return fetchCoinPrices(["tether"]).then(function(d){if(d&&d.tether&&d.tether.krw){cachedUsdt={r:d.tether.krw,t:Date.now(),src:"CoinGecko"};return d.tether.krw}return getRate().then(function(rt){cachedUsdt={r:rt,t:Date.now(),src:"í™˜ìœ¨"};return rt})})})
}
function doTxn(aid,type){var a=null;S.assets.forEach(function(x){if(x.id===aid)a=x});if(!a)return;var isU=a.isUsdt;var uqe=document.getElementById("tx-uq");var p=Number(document.getElementById("tx-p").value);var qe=document.getElementById("tx-q");var q=qe?Number(qe.value):1;if(isU){var uq=uqe?Number(uqe.value):0;if(!uq)return;getUsdtRate().then(function(rt){var krw=Math.round(uq*rt);if(!a.txns)a.txns=[];var userMemo=(document.getElementById("tx-m").value||"").trim();var src=cachedUsdt&&cachedUsdt.src?cachedUsdt.src:"";a.txns.push({id:Date.now(),type:type,price:krw,qty:1,account:(document.getElementById("tx-a").value||"").trim()||null,date:document.getElementById("tx-d").value||toDay(),memo:userMemo||(uq+" USDT (1USDT="+Math.round(rt)+"ì›"+(src?" "+src:"")+")")});S.history=mkSnap(S.assets,S.history);save();closeM();render()});return}if(!p||(qe&&!q))return;var cur=document.getElementById("tx-cur");var isUSD=cur&&cur.value==="USD";function saveTxn(finalP,rate){if(!a.txns)a.txns=[];a.txns.push({id:Date.now(),type:type,price:finalP,qty:q,account:(document.getElementById("tx-a").value||"").trim()||null,date:document.getElementById("tx-d").value||toDay(),memo:(document.getElementById("tx-m").value||"").trim()||(isUSD?"$"+p+" ("+Math.round(rate)+"ì›/ë‹¬ëŸ¬)":null)});S.history=mkSnap(S.assets,S.history);save();closeM();render()}if(isUSD){getRate().then(function(rt){saveTxn(Math.round(p*rt),rt)})}else{saveTxn(p,0)}}
function openTxnList(aid){var a=null;S.assets.forEach(function(x){if(x.id===aid)a=x});if(!a)return;var txns=(a.txns||[]).slice().reverse();var h="<div style=\"margin-bottom:12px;display:flex;gap:6px\"><button class=\"btn-buy\" onclick=\"closeM();setTimeout(function(){openTxn("+a.id+","+Q+"buy"+Q+")},100)\">+ "+txL(a.category,"buy")+"</button><button class=\"btn-sell\" onclick=\"closeM();setTimeout(function(){openTxn("+a.id+","+Q+"sell"+Q+")},100)\">+ "+txL(a.category,"sell")+"</button></div>";if(!txns.length)h+="<div style=\"text-align:center;color:var(--t4);padding:20px;font-size:13px\">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>";else txns.forEach(function(t){h+="<div class=\"txr\" style=\"padding:9px 0\"><span class=\"txt "+(t.type==="buy"?"txb":"txs")+"\">"+txL(a.category,t.type)+"</span><div style=\"flex:1\"><div><span style=\"color:var(--t1);font-weight:600\">"+fF(t.price)+"</span> Ã— "+t.qty+" = <span style=\"color:var(--t1);font-weight:600\">"+fF(t.price*t.qty)+"</span></div><div style=\"font-size:10px;color:var(--t5);margin-top:2px\">"+(t.date||"")+(t.account?" Â· "+esc(t.account):"")+(t.memo?" Â· "+esc(t.memo):"")+"</div></div><button class=\"ibtn\" style=\"background:rgba(239,68,68,.05);color:var(--red);width:28px;height:28px;font-size:11px\" onclick=\"delTxn("+a.id+","+t.id+")\">âœ•</button></div>"});h+="<div class=\"mbtn\" style=\"margin-top:14px\"><button class=\"btn btn-g btn-w\" onclick=\"closeM()\">ë‹«ê¸°</button></div>";openM(a.name+" ê±°ë˜ ë‚´ì—­",h)}
function delTxn(aid,tid){var a=null;S.assets.forEach(function(x){if(x.id===aid)a=x});if(!a)return;a.txns=a.txns.filter(function(t){return t.id!==tid});S.history=mkSnap(S.assets,S.history);save();closeM();openTxnList(aid)}

function openAdd(){var h="<div class=\"fld\"><label>ìì‚° ë¶„ë¥˜</label><div class=\"sel-wrap\"><select id=\"f-cat\" onchange=\"onCC()\">"+catOpts("êµ­ë‚´ì£¼ì‹")+"</select></div></div><div class=\"fld\"><label>ìì‚°ëª…</label><input id=\"f-name\" placeholder=\"ì˜ˆ: ì‚¼ì„±ì „ì, ë¹„íŠ¸ì½”ì¸, í…ŒìŠ¬ë¼\"></div><div id=\"f-extra\"></div><div class=\"mbtn\"><button class=\"btn btn-g\" onclick=\"closeM()\">ì·¨ì†Œ</button><button class=\"btn btn-p\" style=\"flex:2\" onclick=\"doAdd()\">ì¶”ê°€í•˜ê¸°</button></div>";openM("ìƒˆ ìì‚° ì¶”ê°€",h);onCC()}
function onCC(){var cat=document.getElementById("f-cat").value,ex=document.getElementById("f-extra"),ni=document.getElementById("f-name");var ph={"êµ­ë‚´ì£¼ì‹":"ì˜ˆ: ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤","í•´ì™¸ì£¼ì‹":"ì˜ˆ: ì• í”Œ, í…ŒìŠ¬ë¼, ì—”ë¹„ë””ì•„","ì½”ì¸":"ì˜ˆ: ë¹„íŠ¸ì½”ì¸, ì´ë”ë¦¬ì›€","í˜„ê¸ˆ":"ì˜ˆ: ë†í˜‘ ì€í–‰ í†µì¥, CMA ê³„ì¢Œ","ì˜ˆì ê¸ˆ":"ì˜ˆ: ê³µì œíšŒ, ì²­ë…„ë„ì•½ê³„ì¢Œ","ë¶€ë™ì‚°":"ì˜ˆ: ê°•ë‚¨ ì•„íŒŒíŠ¸, ì˜¤í”¼ìŠ¤í…”","ê¸°íƒ€":"ì˜ˆ: ê¸ˆ, ë‹¬ëŸ¬, ì—°ê¸ˆ"};if(ni)ni.placeholder=ph[cat]||"ìì‚°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”";if(cat==="êµ­ë‚´ì£¼ì‹"){ex.innerHTML="<div class=\"fld\"><label>ì¢…ëª©ì½”ë“œ</label><input id=\"f-code\" placeholder=\"ì˜ˆ: 005930\"><div class=\"ht\">ì¢…ëª©ì½”ë“œ ì…ë ¥ ì‹œ ê°€ê²© ìë™ ì—…ë°ì´íŠ¸</div><div class=\"cgrid\">"+KR_STOCKS.map(function(s){return"<div class=\"cchip\" onclick=\"selKr("+Q+s.c+Q+","+Q+s.n+Q+")\">"+s.n+"</div>"}).join("")+"</div></div><div class=\"fld\"><label>ì‹œì¥</label><div class=\"mkt-sel\"><button class=\"mkt-opt sel\" id=\"mk-a\" onclick=\"selMk("+Q+"KOSPI"+Q+")\">KOSPI</button><button class=\"mkt-opt\" id=\"mk-b\" onclick=\"selMk("+Q+"KOSDAQ"+Q+")\">KOSDAQ</button></div></div>"}else if(cat==="í•´ì™¸ì£¼ì‹"){ex.innerHTML="<div class=\"fld\"><label>ğŸ‡°ğŸ‡· êµ­ë‚´ ìƒì¥ í•´ì™¸ ETF</label><div class=\"ht\">í•œêµ­ ê±°ë˜ì†Œì— ìƒì¥ëœ í•´ì™¸ íˆ¬ì ETF (ì›í™” ê±°ë˜)</div><div class=\"cgrid\" id=\"kr-etf-grid\">"+KR_FOREIGN_ETF.slice(0,8).map(function(s){return"<div class=\"cchip\" onclick=\"selKrEtf("+Q+s.c+Q+","+Q+s.n+Q+")\">"+s.n+"</div>"}).join("")+"</div><button style=\"border:none;background:none;color:#60A5FA;font-size:11px;cursor:pointer;font-family:inherit;margin-top:4px;padding:0\" id=\"kr-etf-more\" onclick=\"showAllKrEtf()\">+ ë”ë³´ê¸° ("+KR_FOREIGN_ETF.length+"ì¢…ëª©)</button></div><div style=\"border-top:1px solid rgba(255,255,255,.04);margin:10px 0\"></div><div class=\"fld\"><label>ğŸŒ í•´ì™¸ ì§ì ‘íˆ¬ì ì¢…ëª©</label><input id=\"f-code\" placeholder=\"í‹°ì»¤: AAPL, TSLA ë˜ëŠ” ETF ì¢…ëª©ì½”ë“œ: 360750\"><div class=\"ht\">í‹°ì»¤ ì…ë ¥ ì‹œ USDâ†’ì› ìë™ ë³€í™˜ / ì¢…ëª©ì½”ë“œ ì…ë ¥ ì‹œ ì›í™” ì§ì ‘ ì¡°íšŒ</div><div class=\"cgrid\">"+[["AAPL","ì• í”Œ"],["MSFT","MS"],["GOOGL","êµ¬ê¸€"],["AMZN","ì•„ë§ˆì¡´"],["NVDA","ì—”ë¹„ë””ì•„"],["TSLA","í…ŒìŠ¬ë¼"],["META","ë©”íƒ€"],["NFLX","ë„·í”Œë¦­ìŠ¤"]].map(function(s){return"<div class=\"cchip\" onclick=\"selUs("+Q+s[0]+Q+","+Q+s[1]+Q+")\">"+s[1]+"</div>"}).join("")+"</div></div><input type=\"hidden\" id=\"f-krxEtf\" value=\"\">"}else if(cat==="ì½”ì¸"){ex.innerHTML="<div class=\"fld\"><label>ì½”ì¸ ì„ íƒ</label><div class=\"cgrid\">"+TOP_COINS.map(function(id){return"<div class=\"cchip\" data-id=\""+id+"\" onclick=\"selCo("+Q+id+Q+")\">"+(COIN_KR[id]||id)+"</div>"}).join("")+"</div><input id=\"f-coinId\" placeholder=\"ë˜ëŠ” CoinGecko ID ì§ì ‘ ì…ë ¥\" style=\"width:100%;padding:8px 11px;border-radius:9px;border:1px solid rgba(255,255,255,.06);background:var(--card2);color:var(--t1);font-size:12px;outline:none;font-family:inherit;margin-top:6px\"><div class=\"ht\">ì½”ì¸ ì„ íƒ ì‹œ ê°€ê²© ìë™ ì—…ë°ì´íŠ¸</div></div>"}else if(cat==="í˜„ê¸ˆ"){ex.innerHTML="<div class=\"fld\"><label>ë¹ ë¥¸ ì„ íƒ</label><div class=\"cgrid\">"+[["ë†í˜‘ ì€í–‰ í†µì¥","ğŸ’š"],["CMA ê³„ì¢Œ","ğŸ“Š"],["ì¹´ì¹´ì˜¤ë±…í¬ í†µì¥","ğŸŸ¡"],["í† ìŠ¤ë±…í¬ í†µì¥","ğŸ”µ"]].map(function(s){return"<div class=\"cchip\" onclick=\"selName("+Q+s[0]+Q+")\">"+s[1]+" "+s[0]+"</div>"}).join("")+"<div class=\"cchip\" onclick=\"selUsdt()\" style=\"border:1px solid rgba(16,185,129,.2)\">ğŸ’² USDT ë³´ìœ ë¶„</div></div><div class=\"ht\">ì„ íƒí•˜ê±°ë‚˜ ìœ„ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div></div><input type=\"hidden\" id=\"f-isUsdt\" value=\"\">"}else if(cat==="ì˜ˆì ê¸ˆ"){ex.innerHTML="<div class=\"fld\"><label>ë¹ ë¥¸ ì„ íƒ</label><div class=\"cgrid\">"+[["ê³µì œíšŒ","ğŸ›ï¸"],["ì²­ë…„ë„ì•½ê³„ì¢Œ","ğŸŒ±"],["ì •ê¸°ì ê¸ˆ","ğŸ¦"],["ISA ê³„ì¢Œ","ğŸ“ˆ"]].map(function(s){return"<div class=\"cchip\" onclick=\"selName("+Q+s[0]+Q+")\">"+s[1]+" "+s[0]+"</div>"}).join("")+"</div><div class=\"ht\">ì„ íƒí•˜ê±°ë‚˜ ìœ„ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div></div>"}else{ex.innerHTML=""}}
function selMk(m){selMarket=m;var a=document.getElementById("mk-a"),b=document.getElementById("mk-b");if(a)a.classList.toggle("sel",m==="KOSPI");if(b)b.classList.toggle("sel",m==="KOSDAQ")}
function selKr(c,n){document.getElementById("f-code").value=c;var ni=document.getElementById("f-name");if(ni&&!ni.value)ni.value=n;document.querySelectorAll("#f-extra .cchip").forEach(function(el){el.classList.remove("sel")});if(event&&event.currentTarget)event.currentTarget.classList.add("sel")}
function selUs(t,n){document.getElementById("f-code").value=t;var ni=document.getElementById("f-name");if(ni&&!ni.value)ni.value=n;var ke=document.getElementById("f-krxEtf");if(ke)ke.value="";document.querySelectorAll("#f-extra .cchip").forEach(function(el){el.classList.remove("sel")});if(event&&event.currentTarget)event.currentTarget.classList.add("sel")}
function selKrEtf(c,n){document.getElementById("f-code").value=c;var ni=document.getElementById("f-name");if(ni)ni.value=n;var ke=document.getElementById("f-krxEtf");if(ke)ke.value="1";document.querySelectorAll("#f-extra .cchip").forEach(function(el){el.classList.remove("sel")});if(event&&event.currentTarget)event.currentTarget.classList.add("sel")}
function showAllKrEtf(){var g=document.getElementById("kr-etf-grid"),btn=document.getElementById("kr-etf-more");if(!g)return;g.innerHTML=KR_FOREIGN_ETF.map(function(s){return"<div class=\"cchip\" onclick=\"selKrEtf("+Q+s.c+Q+","+Q+s.n+Q+")\">"+s.n+"</div>"}).join("");if(btn)btn.style.display="none"}
function selCo(id){document.querySelectorAll("#f-extra .cchip").forEach(function(el){el.classList.toggle("sel",el.dataset&&el.dataset.id===id)});var inp=document.getElementById("f-coinId");if(inp)inp.value=id;var ni=document.getElementById("f-name");if(ni&&!ni.value)ni.value=COIN_KR[id]||id}
function selName(n){var ni=document.getElementById("f-name");if(ni)ni.value=n;var uf=document.getElementById("f-isUsdt");if(uf)uf.value="";document.querySelectorAll("#f-extra .cchip").forEach(function(el){el.classList.remove("sel")});if(event&&event.currentTarget)event.currentTarget.classList.add("sel")}
function selUsdt(){var ni=document.getElementById("f-name");if(ni)ni.value="USDT ë³´ìœ ë¶„";var uf=document.getElementById("f-isUsdt");if(uf)uf.value="1";document.querySelectorAll("#f-extra .cchip").forEach(function(el){el.classList.remove("sel")});if(event&&event.currentTarget)event.currentTarget.classList.add("sel")}
function doAdd(){var name=((document.getElementById("f-name")||{}).value||"").trim();var cat=(document.getElementById("f-cat")||{}).value;if(!name)return;var item={name:name,category:cat,amount:0,id:Date.now(),lpu:null,coinId:null,stockCode:null,market:null,krxEtf:false,isUsdt:false,txns:[]};if(cat==="ì½”ì¸")item.coinId=((document.getElementById("f-coinId")||{}).value||"").trim()||resolveCoinId(name);if(cat==="êµ­ë‚´ì£¼ì‹"){item.stockCode=((document.getElementById("f-code")||{}).value||"").trim()||null;item.market=selMarket}if(cat==="í•´ì™¸ì£¼ì‹"){var code=(((document.getElementById("f-code")||{}).value||"").trim())||null;var isKrx=document.getElementById("f-krxEtf");if(isKrx&&isKrx.value==="1"){item.stockCode=code;item.krxEtf=true;item.market="KOSPI"}else if(code&&/^\d{6}$/.test(code)){item.stockCode=code;item.krxEtf=true;item.market="KOSPI"}else{item.stockCode=code?code.toUpperCase():null}}var uf=document.getElementById("f-isUsdt");if(cat==="í˜„ê¸ˆ"&&uf&&uf.value==="1")item.isUsdt=true;S.assets.push(item);save();closeM();render()}

function openEdit(id){var a=null;S.assets.forEach(function(x){if(x.id===id)a=x});if(!a)return;var ex="";if(a.category==="êµ­ë‚´ì£¼ì‹")ex="<div class=\"fld\"><label>ì¢…ëª©ì½”ë“œ</label><input id=\"e-code\" value=\""+esc(a.stockCode||"")+"\"></div><div class=\"fld\"><label>ì‹œì¥</label><div class=\"mkt-sel\"><button class=\"mkt-opt"+(a.market!=="KOSDAQ"?" sel":"")+"\" onclick=\"this.classList.add("+Q+"sel"+Q+");this.nextElementSibling.classList.remove("+Q+"sel"+Q+");document.getElementById("+Q+"e-mkt"+Q+").value="+Q+"KOSPI"+Q+"\">KOSPI</button><button class=\"mkt-opt"+(a.market==="KOSDAQ"?" sel":"")+"\" onclick=\"this.classList.add("+Q+"sel"+Q+");this.previousElementSibling.classList.remove("+Q+"sel"+Q+");document.getElementById("+Q+"e-mkt"+Q+").value="+Q+"KOSDAQ"+Q+"\">KOSDAQ</button></div><input type=\"hidden\" id=\"e-mkt\" value=\""+(a.market||"KOSPI")+"\"></div>";if(a.category==="í•´ì™¸ì£¼ì‹")ex="<div class=\"fld\"><label>"+(a.krxEtf?"ì¢…ëª©ì½”ë“œ (êµ­ë‚´ ìƒì¥)":"í‹°ì»¤")+"</label><input id=\"e-code\" value=\""+esc(a.stockCode||"")+"\">"+(a.krxEtf?"<div class=\"ht\">ğŸ‡°ğŸ‡· êµ­ë‚´ ìƒì¥ í•´ì™¸ ETF Â· ì›í™” ê±°ë˜</div>":"")+"</div>";if(a.category==="ì½”ì¸")ex="<div class=\"fld\"><label>CoinGecko ID</label><input id=\"e-coinId\" value=\""+esc(a.coinId||"")+"\"></div>";openM("ìì‚° ìˆ˜ì •","<div class=\"fld\"><label>ë¶„ë¥˜</label><div class=\"sel-wrap\"><select id=\"e-cat\">"+catOpts(a.category)+"</select></div></div><div class=\"fld\"><label>ìì‚°ëª…</label><input id=\"e-name\" value=\""+esc(a.name)+"\"></div>"+ex+"<div class=\"mbtn\"><button class=\"btn btn-g\" onclick=\"closeM()\">ì·¨ì†Œ</button><button class=\"btn btn-p\" style=\"flex:2\" onclick=\"doEdit("+id+")\">ì €ì¥</button></div>")}
function doEdit(id){var a=null;S.assets.forEach(function(x){if(x.id===id)a=x});if(!a)return;a.name=((document.getElementById("e-name")||{}).value||"").trim()||a.name;a.category=(document.getElementById("e-cat")||{}).value||a.category;if(document.getElementById("e-coinId"))a.coinId=document.getElementById("e-coinId").value.trim()||null;if(document.getElementById("e-code"))a.stockCode=document.getElementById("e-code").value.trim()||null;if(document.getElementById("e-mkt"))a.market=document.getElementById("e-mkt").value||"KOSPI";S.history=mkSnap(S.assets,S.history);save();closeM();render()}
function openDel(id){var a=null;S.assets.forEach(function(x){if(x.id===id)a=x});if(!a)return;openM("ìì‚° ì‚­ì œ","<div style=\"font-size:13.5px;color:var(--t3);margin-bottom:16px\"><strong style=\"color:var(--red)\">"+esc(a.name)+"</strong>ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span style=\"font-size:12px;color:var(--t4)\">ê±°ë˜ ë‚´ì—­ "+((a.txns||[]).length)+"ê±´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</span></div><div class=\"mbtn\"><button class=\"btn btn-g\" onclick=\"closeM()\">ì·¨ì†Œ</button><button class=\"btn btn-d\" onclick=\"doDel("+id+")\">ì‚­ì œ</button></div>")}
function doDel(id){S.assets=S.assets.filter(function(a){return a.id!==id});S.history=mkSnap(S.assets,S.history);save();closeM();render()}
function openReset(){openM("ì „ì²´ ì´ˆê¸°í™”","<div style=\"font-size:13.5px;color:var(--t3);margin-bottom:16px\">ëª¨ë“  ë°ì´í„°ê°€ <strong style=\"color:var(--red)\">ì˜êµ¬ ì‚­ì œ</strong>ë©ë‹ˆë‹¤.</div><div class=\"mbtn\"><button class=\"btn btn-g\" onclick=\"closeM()\">ì·¨ì†Œ</button><button class=\"btn btn-d\" onclick=\"doReset()\">ì´ˆê¸°í™”</button></div>")}
function doReset(){S={assets:[],history:[],saved:null,catOrder:null,coinShowPL:true};logs=[];expanded={};try{localStorage.removeItem(SK)}catch(e){}closeM();render()}
function doSnap(){S.history=mkSnap(S.assets,S.history);save();render();var b=document.getElementById("btnSnap");if(b){b.style.animation="flash .6s ease";setTimeout(function(){b.style.animation=""},700)}showToast("âœ… "+toDay()+" ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")}
function showToast(msg){var old=document.getElementById("toast-el");if(old)old.remove();var d=document.createElement("div");d.id="toast-el";d.textContent=msg;d.style.cssText="position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1A1D23,#252830);color:#F1F5F9;padding:14px 24px;border-radius:14px;font-size:13.5px;font-weight:600;z-index:9999;border:1px solid rgba(16,185,129,.2);box-shadow:0 12px 40px rgba(0,0,0,.5);animation:fadeUp .3s ease;font-family:Pretendard Variable,sans-serif";document.body.appendChild(d);setTimeout(function(){d.style.opacity="0";d.style.transition="opacity .3s";setTimeout(function(){d.remove()},300)},2200)}
function toggleEdit(){editMode=!editMode;render()}
function getCats(){if(S.catOrder&&S.catOrder.length===CATS.length){var valid=true;CATS.forEach(function(c){if(S.catOrder.indexOf(c)<0)valid=false});if(valid)return S.catOrder}return CATS.slice()}
function moveCat(cat,dir){var ord=getCats();var idx=ord.indexOf(cat);if(idx<0)return;var ni=idx+dir;if(ni<0||ni>=ord.length)return;var tmp=ord[idx];ord[idx]=ord[ni];ord[ni]=tmp;S.catOrder=ord;save();render()}
function moveAsset(id,dir){var a=null,idx=-1;S.assets.forEach(function(x,i){if(x.id===id){a=x;idx=i}});if(!a||idx<0)return;var cat=a.category;var sameIdx=[];S.assets.forEach(function(x,i){if(x.category===cat)sameIdx.push(i)});var posInCat=sameIdx.indexOf(idx);var newPos=posInCat+dir;if(newPos<0||newPos>=sameIdx.length)return;var gi=sameIdx[posInCat],gj=sameIdx[newPos];var tmp=S.assets[gi];S.assets[gi]=S.assets[gj];S.assets[gj]=tmp;save();render()}
function usdToKrw(usd){var r=(cachedRate&&cachedRate.r)?cachedRate.r:1350;return Math.round(usd*r)}
function getCurRate(){return(cachedRate&&cachedRate.r)?cachedRate.r:1350}
/* === ì§€ê°‘ ì—°ë™ === */
var WL_CHAINS=[
{id:"eth",name:"Ethereum",symbol:"ETH",ic:"âŸ ",rpc:"https://ethereum-rpc.publicnode.com",decimals:18,coingeckoId:"ethereum",explorer:"https://etherscan.io/address/"},
{id:"bsc",name:"BNB Chain",symbol:"BNB",ic:"ğŸ”¶",rpc:"https://bsc-dataseed.binance.org",decimals:18,coingeckoId:"binancecoin",explorer:"https://bscscan.com/address/"},
{id:"polygon",name:"Polygon",symbol:"POL",ic:"ğŸŸ£",rpc:"https://polygon-rpc.com",decimals:18,coingeckoId:"matic-network",explorer:"https://polygonscan.com/address/"},
{id:"arb",name:"Arbitrum",symbol:"ETH",ic:"ğŸ”µ",rpc:"https://arb1.arbitrum.io/rpc",decimals:18,coingeckoId:"ethereum",explorer:"https://arbiscan.io/address/"},
{id:"op",name:"Optimism",symbol:"ETH",ic:"ğŸ”´",rpc:"https://mainnet.optimism.io",decimals:18,coingeckoId:"ethereum",explorer:"https://optimistic.etherscan.io/address/"},
{id:"avax",name:"Avalanche",symbol:"AVAX",ic:"ğŸ”º",rpc:"https://api.avax.network/ext/bc/C/rpc",decimals:18,coingeckoId:"avalanche-2",explorer:"https://snowtrace.io/address/"}
];
var WL_TOKENS=[
{symbol:"USDT",name:"Tether",coingeckoId:"tether",decimals:6,contracts:{eth:"0xdAC17F958D2ee523a2206206994597C13D831ec7",bsc:"0x55d398326f99059fF775485246999027B3197955",polygon:"0xc2132D05D31c914a87C6611C10748AEb04B58e8F",arb:"0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9",op:"0x94b008aA00579c1307B0EF2c499aD98a8cE58e58",avax:"0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7"}},
{symbol:"USDC",name:"USD Coin",coingeckoId:"usd-coin",decimals:6,contracts:{eth:"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",bsc:"0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d",polygon:"0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359",arb:"0xaf88d065e77c8cC2239327C5EDb3A432268e5831",op:"0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85",avax:"0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E"}},
{symbol:"DAI",name:"Dai",coingeckoId:"dai",decimals:18,contracts:{eth:"0x6B175474E89094C44Da98b954EedeAC495271d0F",polygon:"0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063"}},
{symbol:"WBTC",name:"Wrapped BTC",coingeckoId:"wrapped-bitcoin",decimals:8,contracts:{eth:"0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599",polygon:"0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6",arb:"0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f"}},
{symbol:"LINK",name:"Chainlink",coingeckoId:"chainlink",decimals:18,contracts:{eth:"0x514910771AF9Ca656af840dff83E8264EcF986CA",bsc:"0xF8A0BF9cF54Bb92F17374d9e9A321E6a111a51bD",polygon:"0x53E0bca35eC356BD5ddDFebbD1Fc0fD03FaBad39"}},
{symbol:"UNI",name:"Uniswap",coingeckoId:"uniswap",decimals:18,contracts:{eth:"0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984",polygon:"0xb33EaAd8d922B1083446DC23f610c2567fB5180f"}},
{symbol:"AAVE",name:"Aave",coingeckoId:"aave",decimals:18,contracts:{eth:"0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9",polygon:"0xD6DF932A45C0f255f85145f286eA0b292B21C90B"}}
];
var walletScanning=false,walletResults=[];
function isValidAddr(a){return /^0x[0-9a-fA-F]{40}$/.test(a)}
function rpcCall(rpcUrl,method,params){return fetch(rpcUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:method,params:params})}).then(function(r){return r.json()}).then(function(d){return d.result})}
function getNativeBalance(chain,addr){return rpcCall(chain.rpc,"eth_getBalance",[addr,"latest"]).then(function(hex){if(!hex)return 0;return parseInt(hex,16)/Math.pow(10,chain.decimals)}).catch(function(){return 0})}
function getTokenBalance(rpcUrl,contractAddr,walletAddr,decimals){var data="0x70a08231000000000000000000000000"+walletAddr.slice(2).toLowerCase();return rpcCall(rpcUrl,"eth_call",[{to:contractAddr,data:data},"latest"]).then(function(hex){if(!hex||hex==="0x")return 0;return parseInt(hex,16)/Math.pow(10,decimals)}).catch(function(){return 0})}
function fetchWalletPrices(ids){var u=ids.filter(function(v,i,a){return a.indexOf(v)===i}).join(",");return fetch("https://api.coingecko.com/api/v3/simple/price?ids="+u+"&vs_currencies=krw,usd").then(function(r){return r.json()}).catch(function(){return{}})}
function openWallet(){
var savedAddr=localStorage.getItem("wl_addr")||"";
var h="<div style=\"padding:2px 0 10px\"><div style=\"font-size:12px;color:var(--t3);margin-bottom:12px\">EVM ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ <strong style=\"color:var(--t1)\">6ê°œ ì²´ì¸</strong>ì˜ ë„¤ì´í‹°ë¸Œ ì½”ì¸ê³¼ ì£¼ìš” í† í° ì”ê³ ë¥¼ ìë™ìœ¼ë¡œ ìŠ¤ìº”í•©ë‹ˆë‹¤.</div>";
h+="<div style=\"display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px\">";
WL_CHAINS.forEach(function(c){h+="<span style=\"font-size:10.5px;padding:3px 8px;background:rgba(255,255,255,.04);border:1px solid var(--bd);border-radius:6px;color:var(--t3)\">"+c.ic+" "+c.name+"</span>"});
h+="</div>";
h+="<div class=\"fld\"><label>ì§€ê°‘ ì£¼ì†Œ (0x...)</label><input id=\"wl-addr\" value=\""+esc(savedAddr)+"\" placeholder=\"0x1234...abcd\" style=\"font-size:13px;font-family:monospace\"></div>";
h+="<div id=\"wl-result\"></div>";
h+="<div class=\"mbtn\" id=\"wl-outer-btns\"><button class=\"btn btn-g\" onclick=\"closeM()\">ë‹«ê¸°</button><button class=\"btn btn-p\" style=\"flex:2\" id=\"wl-scan-btn\" onclick=\"scanWallet()\">ğŸ” ìŠ¤ìº” ì‹œì‘</button></div>";
h+="</div>";
openM("ğŸ”— ì§€ê°‘ ì—°ë™",h);
}
function scanWallet(){
var addr=(document.getElementById("wl-addr").value||"").trim();
if(!isValidAddr(addr)){showToast("âŒ ì˜¬ë°”ë¥¸ EVM ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (0x...)");return}
localStorage.setItem("wl_addr",addr);
walletScanning=true;walletResults=[];
var el=document.getElementById("wl-result");
var btn=document.getElementById("wl-scan-btn");
var ob=document.getElementById("wl-outer-btns");if(ob)ob.style.display="";
if(btn){btn.disabled=true;btn.innerHTML="<span class=\"spinner sm\"></span> ìŠ¤ìº” ì¤‘..."}
el.innerHTML="<div class=\"wl-prog\"><div class=\"wl-prog-bar\" id=\"wl-bar\" style=\"width:0%\"></div></div><div id=\"wl-items\" style=\"margin-top:8px\"></div><div style=\"font-size:11px;color:var(--t4);text-align:center;margin-top:4px\" id=\"wl-status\">ì²´ì¸ ìŠ¤ìº” ì¤€ë¹„ ì¤‘...</div>";
var totalTasks=0,doneTasks=0;
WL_CHAINS.forEach(function(ch){
totalTasks++;
WL_TOKENS.forEach(function(tk){if(tk.contracts[ch.id])totalTasks++});
});
var allIds=WL_CHAINS.map(function(c){return c.coingeckoId});
WL_TOKENS.forEach(function(tk){allIds.push(tk.coingeckoId)});
fetchWalletPrices(allIds).then(function(prices){
var chainPromises=WL_CHAINS.map(function(ch){
return getNativeBalance(ch,addr).then(function(bal){
doneTasks++;updateWlBar(doneTasks,totalTasks);
var p=prices[ch.coingeckoId];
var krw=p?p.krw:0;var usd=p?p.usd:0;
if(bal>0.0001){walletResults.push({type:"native",chain:ch.id,chainName:ch.name,chainIc:ch.ic,symbol:ch.symbol,name:ch.name+" ("+ch.symbol+")",balance:bal,priceKrw:krw,priceUsd:usd,valueKrw:bal*krw,coingeckoId:ch.coingeckoId,checked:true})}
var tokenPromises=WL_TOKENS.filter(function(tk){return tk.contracts[ch.id]}).map(function(tk){
return getTokenBalance(ch.rpc,tk.contracts[ch.id],addr,tk.decimals).then(function(tbal){
doneTasks++;updateWlBar(doneTasks,totalTasks);
if(tbal>0.01){var tp=prices[tk.coingeckoId];var tkrw=tp?tp.krw:0;var tusd=tp?tp.usd:0;
walletResults.push({type:"token",chain:ch.id,chainName:ch.name,chainIc:ch.ic,symbol:tk.symbol,name:tk.name+" ("+ch.name+")",balance:tbal,priceKrw:tkrw,priceUsd:tusd,valueKrw:tbal*tkrw,coingeckoId:tk.coingeckoId,checked:tbal*tusd>=1})}
}).catch(function(){doneTasks++;updateWlBar(doneTasks,totalTasks)})
});
return Promise.all(tokenPromises);
}).catch(function(){doneTasks++;updateWlBar(doneTasks,totalTasks)})
});
return Promise.all(chainPromises);
}).then(function(){
walletScanning=false;
renderWlResults(addr);
}).catch(function(e){
walletScanning=false;
el.innerHTML="<div style=\"color:var(--red);font-size:13px;padding:12px;text-align:center\">âŒ ìŠ¤ìº” ì‹¤íŒ¨: "+e.message+"</div>";
if(btn){btn.disabled=false;btn.innerHTML="ğŸ” ë‹¤ì‹œ ìŠ¤ìº”"}
});
}
function updateWlBar(done,total){
var pct=Math.round(done/total*100);
var bar=document.getElementById("wl-bar");
var st=document.getElementById("wl-status");
if(bar)bar.style.width=pct+"%";
if(st)st.textContent="ìŠ¤ìº” ì¤‘... "+done+"/"+total+" ("+pct+"%)";
}
function renderWlResults(addr){
var el=document.getElementById("wl-result");
var btn=document.getElementById("wl-scan-btn");
if(btn){btn.disabled=false;btn.innerHTML="ğŸ” ë‹¤ì‹œ ìŠ¤ìº”"}
if(!walletResults.length){
el.innerHTML="<div style=\"text-align:center;padding:20px;color:var(--t4);font-size:13px\">ğŸ˜… ì”ê³ ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>";return}
walletResults.sort(function(a,b){return b.valueKrw-a.valueKrw});
var totalKrw=0;walletResults.forEach(function(r){if(r.checked)totalKrw+=r.valueKrw});
var h="<div style=\"margin:10px 0 8px;padding:10px 12px;background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.12);border-radius:10px;display:flex;justify-content:space-between;align-items:center\"><div><div style=\"font-size:11px;color:var(--green);font-weight:600\">âœ… "+walletResults.length+"ê°œ ìì‚° ë°œê²¬</div><div style=\"font-size:10px;color:var(--t4);margin-top:2px\">"+addr.slice(0,8)+"..."+addr.slice(-6)+"</div></div><div style=\"text-align:right\"><div style=\"font-size:14px;font-weight:700;color:var(--t1)\" id=\"wl-total\">"+fSM(Math.round(totalKrw))+"</div><div style=\"font-size:10px;color:var(--t4)\">ì„ íƒ ìì‚° í•©ê³„</div></div></div>";
h+="<div style=\"display:flex;justify-content:flex-end;gap:8px;margin-bottom:6px\"><button style=\"border:none;background:none;color:#60A5FA;font-size:11px;cursor:pointer;font-family:inherit\" onclick=\"wlToggleAll(true)\">ì „ì²´ ì„ íƒ</button><button style=\"border:none;background:none;color:var(--t4);font-size:11px;cursor:pointer;font-family:inherit\" onclick=\"wlToggleAll(false)\">ì „ì²´ í•´ì œ</button></div>";
walletResults.forEach(function(r,i){
var balStr=r.balance>=1?r.balance.toFixed(4):r.balance.toFixed(8);
h+="<div class=\"wl-chain"+(r.balance>0?" found":"")+"\">";
h+="<input type=\"checkbox\" class=\"wl-cb\" "+(r.checked?"checked":"")+" onchange=\"wlToggle("+i+",this.checked)\">";
h+="<div class=\"wl-ic\">"+r.chainIc+"</div>";
h+="<div class=\"wl-info\"><div class=\"wl-nm\">"+r.symbol+"<span style=\"font-size:10px;color:var(--t5);margin-left:5px\">"+r.chainName+"</span></div><div class=\"wl-bal\">"+balStr+" "+r.symbol+"</div></div>";
h+="<div style=\"text-align:right\"><div class=\"wl-val\">"+fSM(Math.round(r.valueKrw))+"</div><div class=\"wl-st\">$"+(r.balance*r.priceUsd>=1?(r.balance*r.priceUsd).toFixed(2):(r.balance*r.priceUsd).toFixed(4))+"</div></div>";
h+="</div>"});
h+="<div class=\"mbtn\" style=\"margin-top:12px\"><button class=\"btn btn-g\" onclick=\"closeM()\">ë‹«ê¸°</button><button class=\"btn btn-p\" style=\"flex:2\" onclick=\"importWallet()\">ğŸ“¥ ì„ íƒ ìì‚° ê°€ì ¸ì˜¤ê¸°</button></div>";
el.innerHTML=h;
var ob=document.getElementById("wl-outer-btns");if(ob)ob.style.display="none";
}
function wlToggle(i,checked){
walletResults[i].checked=checked;
var totalKrw=0;walletResults.forEach(function(r){if(r.checked)totalKrw+=r.valueKrw});
var te=document.getElementById("wl-total");if(te)te.textContent=fSM(Math.round(totalKrw));
}
function wlToggleAll(val){
walletResults.forEach(function(r,i){r.checked=val});
document.querySelectorAll(".wl-cb").forEach(function(cb){cb.checked=val});
var totalKrw=0;walletResults.forEach(function(r){if(r.checked)totalKrw+=r.valueKrw});
var te=document.getElementById("wl-total");if(te)te.textContent=fSM(Math.round(totalKrw));
}
function importWallet(){
var selected=walletResults.filter(function(r){return r.checked});
if(!selected.length){showToast("âš ï¸ ê°€ì ¸ì˜¬ ìì‚°ì„ ì„ íƒí•˜ì„¸ìš”");return}
var merged={};
selected.forEach(function(r){
var key=r.coingeckoId;
if(!merged[key])merged[key]={symbol:r.symbol,name:r.symbol,coingeckoId:r.coingeckoId,totalBalance:0,priceKrw:r.priceKrw,chains:[]};
merged[key].totalBalance+=r.balance;
merged[key].chains.push(r.chainName);
});
var added=0,updated=0;
for(var k in merged){var m=merged[k];
var existing=null;
S.assets.forEach(function(a){if(a.walletCoinId===k)existing=a});
if(existing){
var oldBal=0;(existing.txns||[]).forEach(function(t){if(t.type==="buy")oldBal+=t.qty;else oldBal-=t.qty});
var diff=m.totalBalance-oldBal;
if(Math.abs(diff)>0.0001){
if(!existing.txns)existing.txns=[];
existing.txns.push({id:Date.now()+Math.floor(Math.random()*1000),type:diff>0?"buy":"sell",price:Math.round(m.priceKrw),qty:Math.abs(diff),account:"ì§€ê°‘ ì—°ë™",date:toDay(),memo:"ì§€ê°‘ ë™ê¸°í™” ("+m.chains.join("+")+")"});
existing.amount=Math.round(m.priceKrw);
updated++}
}else{
var coinName=COIN_KR[m.coingeckoId]||m.symbol;
var item={name:coinName,category:"ì½”ì¸",amount:Math.round(m.priceKrw),id:Date.now()+Math.floor(Math.random()*1000),lpu:null,coinId:m.coingeckoId,stockCode:null,market:null,krxEtf:false,isUsdt:false,walletCoinId:k,txns:[{id:Date.now()+1,type:"buy",price:Math.round(m.priceKrw),qty:m.totalBalance,account:"ì§€ê°‘ ì—°ë™",date:toDay(),memo:"ì§€ê°‘ ìŠ¤ìº” ("+m.chains.join("+")+")" }]};
S.assets.push(item);added++}
}
S.history=mkSnap(S.assets,S.history);save();closeM();render();
showToast("âœ… "+added+"ê°œ ì¶”ê°€, "+updated+"ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
}
load();
var isSandbox=false;
function checkSandbox(){return fetch("https://api.coingecko.com/api/v3/ping").then(function(r){return r.ok}).catch(function(){isSandbox=true;return false})}
render();checkSandbox().then(function(){render();fetchRate().then(function(){render()})});
</script></body></html>